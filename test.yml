test_things: &test_things
  four: !calc 2*2
  B: !FirstTrue
    - { value: A, key: false }
    - { value: B, key: true }
    - { value: C, key: true }
  C: !LastTrue
    - { value: A, key: false }
    - { value: B, key: true }
    - { value: C, key: true }
  none: !LastTrue
    - { value: X, key: false }
    - { value: Y, key: false }
    - { value: Z, key: false }

  # Conditionals on an empty list always return null:
  badlt: !LastTrue []
  badft: !FirstTrue []
  badxv: !MaxKey []
  badnv: !MinKey []

theia: &theia !Platform
  <<: *test_things
  machine: THEIA
  ACCOUNT: fv3-cpu
  QUEUE: batch
  QUEUE_ARCH: service
  HPSS_PROJECT: emc-global
  BASE_SVN: /scratch4/NCEPDEV/global/save/glopara/svn
  BASE_GFS: /scratch4/NCEPDEV/global/save/glopara/svn/gfs/branches/gfs_q3fy17/global_shared.v14.1.0
  detect: !calc tools.isdir('/scratch4') and tools.isdir('/scratch3')
  scrub: !MaxKey
    - value: /scratch3/NCEPDEV/stmp1
      key: !calc tools.panasas_gb(value)
    - value: /scratch3/NCEPDEV/stmp2
      key: !calc tools.panasas_gb(value)
    - value: /scratch4/NCEPDEV/stmp3
      key: !calc tools.panasas_gb(value)
    - value: /scratch4/NCEPDEV/stmp4
      key: !calc tools.panasas_gb(value)

wcoss_cray: &wcoss_cray !Platform
  <<: *test_things
  machine: THEIA
  ACCOUNT: fv3-cpu
  QUEUE: batch
  QUEUE_ARCH: service
  HPSS_PROJECT: emc-global
  BASE_SVN: /scratch4/NCEPDEV/global/save/glopara/svn
  BASE_GFS: /scratch4/NCEPDEV/global/save/glopara/svn/gfs/branches/gfs_q3fy17/global_shared.v14.1.0
  scrub: !MaxKey
    - value: /gpfs/hps2/ptmp
      key: !calc tools.gpfs_gb(value,'hps2-ptmp','hps2')
    - value: /gpfs/hps3/ptmp
      key: !calc tools.gpfs_gb(value,'hps3-ptmp','hps3')
  detect: !calc tools.isdir('/gpfs/hps') and tools.isfile('/etc/SuSE-release')

platform: !FirstTrue
  - value: *wcoss_cray
    key: !calc value.detect
  - value: *theia
    key: !calc value.detect

more_vars: &more_vars !Template
  b:
    type: int
    description: 'Sample integer b'
  dog:
    type: string
    default: 'brown'

fcst_vars: &fcst_vars !Template
  do_vort_damp:
    type: bool
  a:
    type: int
    allowed: [ 10, 20, 30 ]
    description: "Sample integer a"
# if_present is not useful.  We need to condition on the value.
    if_present: !FirstTrue
      - value: *more_vars
        key: !calc a==10
  cow:
    type: string
    allowed: [ brown, black, white, red, blue ]
    description: "Color of a cow"
    default: blue
  lencow:
    type: int
    description: "Length of the cow"
    default: !calc len(cow)

fcst: &fcst !Action
  Template: *fcst_vars
  do_vort_damp: true
  consv_te: 0.
  fv_sg_adj: 900
  dspheat: false
  shal_cnv: true
  agrid_vel_rst: true
  master_grid: "0p5deg"
  TYPE: hydro
  MONO: mono
  a: !calc 5 + 5
  b: !calc a*2
  c: !calc fv_sg_adj+b
  d: !MaxKey
    - key: a
      value: !calc 10*a
    - key: b
      value: !calc 10*b
    - key: c
      value: !calc 10*c

gfspost: &gfspost !Action
  Template: *fcst_vars
  somevar: somevalue
    
gfsfcst: &gfsfcst !Action
    <<: *fcst
    stuff: [ !calc a+b , !calc 2*2 ]
    DIAG_TABLE: !calc doc.platform.BASE_GFS + "/parm/parm_fv3diag/diag_table"

suite: !Cycle
   Clock:
     start: 2017-02-14t18:00:00
     end: 2017-02-19t12:00:00
     step: !calc 6*3600
   gfs: !Family
     fcst: !Task
       Perform: [ *gfsfcst ]
       Trigger: !Depend doc.suite.at(hours=-6).gdas.anal
       Time: !Timespec doc.suite.clock(hours=+3)
     post: !Task
       Perform: [ *gfspost ]
       Trigger: !Trigger fcst==RUNNING

action_template: &action_template
  BASE_GSI: !calc doc.platform.places.BASE_GSI
  BASE_GSM: !calc doc.platform.places.BASE_GSM
  ...

ecen: &ecen_action
  <<: *action_template

  # ----------------------------------------
  # From config.resources
  walltime: !timedelta 00:30:00
  resources: !calc run_ecen
  rocoto_memory: "3072M"

  # Each command (APRUN_whatever) in config.resources needs a
  # run_whatever entry in the corresponding action.
  # Executable name is specified deep inside scripts
  # Use "placeholder" for exe name
  # ----------------------------------------
  # From config.ecen
  ENKFRECENSH: !expand "{BASE_GSI}/scripts/EnKF/scripts_ncep/exglobal_enkf_recenter_fv3gfs.sh.ecf"
  nth_ecen: 2
  CHGRESSH: !expand "{BASE_GSM}/ush/global_chgres_GSM.sh"
  CHGRESEXEC: !expand "{BASE_GSM}/exec/global_chgres_GSM"
  CHGRESVARS_ENKF: "use_ufo=.true.,nopdpvv=.true."
  CHGRESTHREAD: 12

epos: &epos_action
  <<: *action_template
  walltime: !timedelta 00:15:00
  resources: !calc run_epos
  rocoto_memory: "3072M"
  ENKFPOSTSH: !expand "{BASE_GSI}/scripts/EnKF/scripts_ncep/exglobal_enkf_post_fv3gfs.sh.ecf"
  nth_epos: 2

eobs: &eobs_action
  <<: *action_template
  walltime: !timedelta 00:15:00
  resources: !calc run_eobs
  rocoto_memory: "3072M"
  INVOBSSH: !expand "{BASE_GSI}/scripts/exglobal_innovate_obs_fv3gfs.sh.ecf"
  ENKFINVOBSSH: !expand "{BASE_GSI}/scripts/EnKF/scripts_ncep/exglobal_enkf_innovate_obs_fv3gfs.sh.ecf"
  NMEM_EOMGGRP: 10
  RERUN_EOMGGRP: "YES"
  npe_gsi: !expand "{npe_eobs}"
  nth_gsi: 4
# GSI namelist options related to observer for EnKF
  OBSINPUT_INVOBS: "dmesh(1)=225.0,dmesh(2)=225.0"
  OBSQC_INVOBS: "tcp_width=60.0,tcp_ermin=2.0,tcp_ermax=12.0"
  nth_eobs: 2

eomg: &eomg_action
  <<: *action_template
  walltime: !timedelta 00:15:00
  resources: !calc run_eomg
  rocoto_memory: "3072M"
  nth_eomg: 2

eupd: &eupd_action
  <<: *action_template
  walltime: !timedelta 00:15:00
  resources: !calc run_eupd
  rocoto_memory: "3072M"
  ENKFUPDSH: !expand "{BASE_GSI}/scripts/EnKF/scripts_ncep/exglobal_enkf_update_fv3gfs.sh.ecf"
  ENKFEXEC: !expand "{BASE_GSI}/exec/global_enkf"
  npe_enkf: !expand "{npe_eupd}"
  nth_enkf: 4
  nth_eupd: 2

efcs: &efcs_action
  <<: *action_template
  walltime: !timedelta 00:15:00
  resources: !calc run_efcs
  rocoto_memory: "3072M"
  npe_fv3: !expand "{npe_efcs}"
  nth_fv3: 1

  ENKFFCSTSH: !expand "{BASE_GSI}/scripts/EnKF/scripts_ncep/exglobal_enkf_fcst_fv3gfs.sh.ecf"
  NMEM_EFCSGRP: 10
  RERUN_EFCSGRP: "NO"

# Stochastic physics parameters (only for ensemble forecasts)
  SET_STP_SEED: "YES"
  DO_SKEB: ".false."
  SKEB: 0.8
  SKEB_TAU: 21600.
  SKEB_LSCALE: 500000.
  SKEBNORM: 1
  DO_SHUM: ".false."
  SHUM: 0.006
  SHUM_TAU: 21600.
  SHUM_LSCALE: 250000.
  DO_SPPT: ".false."
  SPPT: 0.8
  SPPT_TAU: 21600.
  SPPT_LSCALE: 500000.

  DIAG_TABLE: !expand "{BASE_GSM}/parm/parm_fv3diag/diag_table_da"
  restart_interval: 6

  nth_efcs: 2

earc: &earc_action
  <<: *action_template
  walltime: !timedelta 00:15:00
  resources: !calc run_earc
  rocoto_memory: "3072M"
  NMEM_EARCGRP: 10
  nth_earc: 2

prep: &prep_action
  <<: *action_template
  walltime: !timedelta 00:10:00
  resources: !calc run_prep
  rocoto_memory: "3072M"
  DO_RELOCATE: "NO"
  DO_MAKEPREPBUFR: "YES"   # if NO, will copy prepbufr from globaldump
  DRIVE_MAKEPREPBUFRSH: !expand "{BASE_GSM}/ush/drive_makeprepbufr.sh"
  nth_prep: 2

anal: &anal_action
  <<: *action_template
  walltime: !timedelta 01:30:00
  resources: !calc run_anal
  rocoto_memory: "3072M"
  ANALYSISSH: !expand "{BASE_GSI}/scripts/exglobal_analysis_fv3gfs.sh.ecf"
  GSIEXEC: !expand "${BASE_GSI}/exec/global_gsi"
  npe_gsi: !expand "{npe_anal}"
  nth_gsi: 4
  nth_anal: 2

fcst: &fcst_action
  <<: *action_template
  walltime: !timedelta 00:10:00
  resources: !calc run_fcst
  rocoto_memory: "3072M"
  FORECASTSH: !expand "{BASE_GSM}/scripts/exglobal_fcst_nemsfv3gfs.sh"
  FCSTEXECDIR: !expand "{BASE_NEMSfv3gfs}/NEMS/exe"
  FCSTEXEC: "fv3_gfs_nh.prod.32bit.x"
  npe_fv3: !expand "{npe_fcst}" # This is model resolution dependent, see note above
  nth_fv3: 2
  TYPE: "nh"
  MONO: "non-mono"
  do_vort_damp: ".true."    # vorticity and divergence damping
  consv_te: "0."            # conserve total energy
  fv_sg_adj: 900            # time-scale to remove 2dz instability
  dspheat: ".false."        # dissipative heating
  shal_cnv: ".true."        # shallow convection
  agrid_vel_rst: ".true."   # write velocity restarts on agrid?

# Disable the use of coupler.res; get model start time from model_configure
# export USE_COUPLER_RES="NO"

  USE_COUPLER_RES: "NO"

  restart_interval: !FirstTrue
    when: !calc CDUMP=="gdas"
    do: 6
  DIAG_TABLE: !FirstTrue
    when: !calc CDUMP=="gdas"
    do: !expand "{BASE_GSM}/parm/parm_fv3diag/diag_table_da"
    when: !calc CDUMP=="gfs"
    do: !expand "{BASE_GSM}/parm/parm_fv3diag/diag_table"

  REGRID_NEMSIO_SH: !expand "{BASE_GSM}/ush/fv3gfs_regrid_nemsio.sh"
  REGRID_NEMSIO_TBL: !expand "{BASE_GSM}/parm/parm_fv3diag/variable_table_da.txt"

  REMAPSH: !expand "{BASE_GSM}/ush/fv3gfs_remap.sh"
  master_grid: "0p5deg" # 1deg 0p5deg 0p25deg 0p125deg etc
  npe_remap: !expand "{npe_fcst}"
  nth_remap: 2
  NC2NEMSIOSH: !expand "{BASE_GSM}/ush/fv3gfs_nc2nemsio.sh"
  nth_fcst: 2

post: &post_action
  <<: *action_template
  walltime: !timedelta 00:15:00
  resources: !calc run_post
  rocoto_memory: "3072M"
  POSTJJOBSH: !expand "{BASE_WORKFLOW}/jobs/JGFS_POST.sh"
  POSTGPSH: !expand "{BASE_POST}/ush/global_nceppost.sh"
  POSTGPEXEC: !expand "{BASE_POST}/exec/ncep_post"
  npe_postgp: !expand "{npe_post}"
  nth_postgp: 1
  GFS_DOWNSTREAM: "YES"
  GFSDOWNSH: !expand "{BASE_WORKFLOW}/ush/fv3gfs_downstream_nems.sh"
  GFSDWNSH: !expand "{BASE_WORKFLOW}/ush/fv3gfs_dwn_nems.sh"
  downset: 1
  npe_dwn: !expand "{npe_post}"
  nth_dwn: 2
  nth_post: 2

arch: &arch_action
  <<: *action_template
  walltime: !timedelta 06:00:00
  resources: !calc run_arch
  rocoto_memory: "3072M"
  nth_arch: 2

vrfy_template: !Template
  VDUMP:       # verifying dump
    type: str
    allowed: [ "gfs", "gdas" ]

  CDUMPFCST: "gdas"  # Fit-to-obs with GDAS/GFS prepbufr
    type: str
    allowed: [ "gfs", "gdas" ]

  CDFNL: "gdas"      # Scores verification against GDAS/GFS analysis
    type: str
    allowed: [ "gfs", "gdas" ]

  VSDB_STEP1:      # populate VSDB database
    type: logic
    allowed: [ "YES", "NO" ]

  VSDB_STEP2:
    type: logic
    allowed: [ "YES", "NO" ]

  VRFYG2OBS:            # Grid to observations
    type: logic
    allowed: [ "YES", "NO" ]

  VRFYFITS:        # Fit to observations
    type: logic
    allowed: [ "YES", "NO" ]

  VRFYPRCP:        # Precip threat scores
    type: logic
    allowed: [ "YES", "NO" ]

  VRFYMINMON:      # GSI minimization monitoring
    type: logic
    allowed: [ "YES", "NO" ]

  VRFYRAD:         # Radiance data assimilation monitoring
    type: logic
    allowed: [ "YES", "NO" ]

  VRFYOZN:         # Ozone data assimilation monitoring
    type: logic
    allowed: [ "YES", "NO" ]

  VRFYTRAK:        # Hurricane track forecasts
    type: logic
    allowed: [ "YES", "NO" ]

  VRFYGENESIS:     # Cyclone genesis
    type: logic
    allowed: [ "YES", "NO" ]

  VRFYGMPK:        # Gempak verification
    type: logic
    allowed: [ "YES", "NO" ]

  CYC_TRACK:
    type: str
    allowed: [ "YES", "NO" ]
    if_present: !FirstTrue
      - when: !calc VRFYTRAK=="YES"
        do: *CYC_TRACK_VARS

  MIN_RAD_OZN:
    type: str
    allowed: [ "YES", "NO" ]
    if_present: !FirstTrue
      - when: !calc ( VRFYRAD=="YES" or VRFYMINMON=="YES" or VRFYOZN=="YES" )
        do: *MIN_RAD_OZN_VARS

  VRFYMINSH:
    type: str
    override: !FirstTrue
      - when: !calc ( not platform.name=="THEIA" and not platform.name=="WCOSS_C" )
        do: NO
        message: !expand "WARNING: Minimization monitoring is not enabled on {platform.name}!"

vrfy: &vrfy_action
  <<: *action_template
  Template: vrfy_template
  walltime: !timedelta 01:00:00
  resources: !calc run_vrfy
  rocoto_memory: "3072M"
  VDUMP: "gfs"       # verifying dump
  CDUMPFCST: "gdas"  # Fit-to-obs with GDAS/GFS prepbufr
  CDFNL: "gdas"      # Scores verification against GDAS/GFS analysis
  VSDB_STEP1: "YES"      # populate VSDB database
  VSDB_STEP2: "NO"
  VRFYG2OBS: "YES"       # Grid to observations
  VRFYFITS: "YES"        # Fit to observations
  VRFYPRCP: "YES"        # Precip threat scores
  VRFYMINMON: "YES"      # GSI minimization monitoring
  VRFYRAD: "YES"         # Radiance data assimilation monitoring
  VRFYOZN: "NO"          # Ozone data assimilation monitoring
  VRFYTRAK: "YES"        # Hurricane track forecasts
  VRFYGENESIS: "YES"     # Cyclone genesis
  VRFYGMPK: "NO"         # Gempak verification

  fitdir: !FirstTrue
    - when: !calc ( machine=="WCOSS_C" & VRFYFITS=="YES" )
      do: !expand "{BASE_SVN}/verif/global/parafits.fv3nems/batrun"
    - when: !calc ( machine=="THEIA" & VRFYFITS=="YES" )
      do: !expand "{BASE_SVN}/verif/global/parafits.fv3nems/batrun"

  PREPQFITSH: !FirstTrue
    - when: !calc ( machine=="WCOSS_C" & VRFYFITS=="YES" )
      do: !expand "{fitdir}/subfits_cray_nems"
    - when: !calc ( machine=="THEIA" & VRFYFITS=="YES" )
      do: !expand "fitdir}/subfits_theia_nems"

  VRFY_CDUMP_GFS: !FirstTrue
    - when: !calc ( CDUMP=="gfs" & ( VSDB_STEP1=="YES" | VRFYPRCP=="YES" | VRFYG2OBS=="YES" ) )
      do: "YES"

  MIN_RAD_OZN: !FirstTrue
    - when: !calc ( VRFYRAD=="YES" | VRFYMINMON=="YES" | VRFYOZN=="YES" )
      do: "YES"

  RAD: !FirstTrue
    - when: !calc VRFYRAD=="YES" & CDUMP=="$CDFNL"
      do: "YES"

  MIN: !FirstTrue
    - when: !calc VRFYMINMON=="YES"
      do: "YES"

  OZN: !FirstTrue
    - when: !calc VRFYOZN=="YES"
      do: "YES"

  CYC_TRACK: !FirstTrue
    - when: !calc VRFYTRAK=="YES"
      do: "YES"

  CYC_GEN: !FirstTrue
    - when: !calc VRFYGENESIS=="YES"
      do: "YES"

  nth_vrfy: 2

CYC_TRACK_VARS: &CYC_TRACK_VARS !Template
  TRACKERSH: 
    type: str 
    default: !expand "{BASE_GSM}/ush/global_tracker.sh"
  PARATRKR: 
    type: str
    default: !expand "{BASE_GSM}/ush/global_extrkr.sh"
  GETTRKEXEC:
    type: str 
    default: !expand "{BASE_GSM}/exec/gettrk"
  GETTX: 
    type: str
    default: !expand "{GETTRKEXEC}"
  SUPVX: 
    type: str
    default: !expand "{BASE_GSM}/exec/supvit"
  HOMERELO: 
    type: str
    default: !expand "{BASE_GSM}"
  homesyndir: 
    type: str
    default: !expand "{BASE_GSM}"
  prep_step: 
    type: str
    default: !expand "{NWPROD}/prod_util.v1.0.15/ush/prep_step"
  FHOUT: 
    type: str
    default: !FirstTrue
      - when: !calc CDUMP=="gfs"
        do: !expand "{FHOUT_GFS}"
  FHMAX: 
    type: str
    default: !FirstTrue
      - when: !calc CDUMP=="gfs"
        do: !expand "{FHMAX_GFS}"
  FHMAX2: 
    type: str
    default: !FirstTrue
      - when: !calc CDUMP=="gfs"
        do: !expand "{FHMAX2_GFS}"
  COMROOTp1: 
    type: str
    default: !FirstTrue
      - when: !calc machine=="THEIA"
        do: "/scratch4/NCEPDEV/rstprod/com"
  archsyndir:  
    type: str
    default: !FirstTrue
      - when: !calc machine=="THEIA"
        do: !expand "{COMROOTp1}/arch/prod/syndat"

CYC_GEN_VARS: &CYC_GEN_VARS !Template
  NWROOTGENESIS: 
    type: str
    default: !FirstTrue
      - when: !calc machine=="WCOSS_C"
        do: "/gpfs/hps3/emc/global/noscrub/emc.glopara/svn/gfs/q3fy17"
      - when: !calc machine=="THEIA"
        do: "/scratch4/NCEPDEV/global/save/glopara/svn/gfs/branches/gfs_q3fy17"
  UTILROOT: 
    type: str
    default: !FirstTrue
      - when: !calc machine=="THEIA"
        do: "/scratch4/NCEPDEV/global/save/glopara/nwpara/prod_util.v1.0.15"
  GETTX_GEN: 
    type: str
    default: !FirstTrue
      - when: !calc machine=="THEIA"
        do: !expand "{NWROOTGENESIS}/ens_tracker.v2.0.1/exec/gettrk_gen_g2_theia"
  GENESISSH: 
    type: str
    default: !FirstTrue
      - when: !calc ( machine=="WCOSS_C" | machine=="THEIA" )
        do: !expand "{NWROOTGENESIS}/ens_tracker.v2.0.1/gfs_genesis_para_fv3gfs.sh"
      - when: !calc ( machine~="WCOSS_C" & machine~="THEIA" )
        do: ""

MIN_VARS: &MIN_VARS !Template
  HOMEgfs: 
    type: str
    default: !expand "{BASE_SVN}/fv3gfs/trunk/gfs.v15.0.0"
  HOMEminmon: 
    type: str
    default: !expand "{BASE_GSM}"
  MINMON_SUFFIX: 
    type: str
    default: !expand "{PSLOT}"
  M_TANKverf: 
    type: str
    default: !expand "{NOSCRUB}/minmon"
  VRFYMINSH: 
    type: str
    default: !FirstTrue
      - when: !calc CDUMP=="gdas" & ( machine=="WCOSS_C" | machine=="THEIA" )
        do: !expand "{HOMEgdas}/jobs/JGDAS_VMINMON"
      - when: !calc CDUMP=="gfs" & ( machine=="WCOSS_C" | machine=="THEIA" )
        do: !expand "{HOMEgfs}/jobs/JGDAS_VMINMON"
      - when: !calc ( machine~="WCOSS_C" & machine~="THEIA" )
        do: !expand "WARNING: Minimization monitoring is not enabled on $machine!"
  VRFYMINMON: 
    type: str
    default: !FirstTrue
      - when: !calc ( machine~="WCOSS_C" & machine~="THEIA" )
        do: "NO"

RAD_VARS: &RAD_VARS !Template
  HOMEradmon: 
    type: str
    default: !expand "{BASE_GSM}"
  RADMON_SUFFIX: 
    type: str
    default: !expand "{PSLOT}"
  TANKverf: 
    type: str
    default: !expand "{NOSCRUB}/radmon"
  VRFYRADSH: 
    type: str
    default: !FirstTrue
      - when: !calc( machine=="WCOSS_C" | machine=="THEIA" )
        do: !expand "{HOMEgdas}/jobs/JGDAS_VERFRAD"
      - when: !calc (machine~="WCOSS_C" & machine~="THEIA" )
        do: !expand "WARNING: Radiance monitoring is not enabled on $machine!"
  VRFYRAD: 
    type: str
    default: !FirstTrue
      - when: !calc ( machine~="WCOSS_C" & machine~="THEIA" )
        do: "NO"

OZN_VARS: &OZN_VARS !Template
# echo "WARNING: Ozone Monitoring is just a stub for now!"
  VRFYOZN: 
    type: logic
    default: "NO"
  OZNDIR: 
    type: str
    default: !expand "{NOSCRUB}/$LOGNAME/ozone/stats/$PSLOT"
  VRFYOZNSH:
    type: str
    default:  ""
  BASEDIR_OZNMON: 
    type: str
    default: !expand "{BASE_OZNMON}/util/Ozone_Monitor"

MIN_RAD_OZN_VARS: &MIN_RAD_OZN_VARS !Template
  HOMEgdas: 
    type: str
    default: !expand "{BASE_GDAS}"
  envir: 
    type: str
    default: "para"

VRFY_CDUMP_GFS_VARS: &VRFY_CDUMP_GFS_VARS !Template
  BACKDATEVSDB: 
    type: int
    default: 24
  VBACKUP_PRCP: 
    type: int
    default: 24
  vsdbsave: 
    type: str
    default: !expand "${NOSCRUB}/archive/vsdb_data"
  vsdbhome: 
    type: str
    default: !expand "${BASE_VERIF}" 
  VSDBSH=: 
    type: str
    default: !expand "${vsdbhome}/vsdbjob.sh"
  vlength=: 
    type: str
    default: !expand "${FHMAX_GFS}"
  vhr_rain: 
    type: str
    default: !expand"${FHMAX_GFS}"
  ftyplist: 
    type: str
    default: "pgbq"

anal_base: &anal_base !Action
  <<: *action_base

  shell_env_scopes:
    - [ doc.data_assimilation,     ".*" ]
    - [ doc.gfs_output_settings,   ".*" ]
    - [ doc.fv3_gdas_settings,     ".*" ]

  J_JOB: anal
  walltime: !timedelta 02:00:00
  resources: !calc run_anal.resources
  anal_resources: !calc run_anal.resources
  gsi_resources: !calc run_gsi.resources
  memory: "3072M"
  accounting: !calc doc.platform.parallel_accounting
  assim_freq: 6

  # FIXME: temporary kludge until gsi scripts are updated:
  APRUN_CALCINC: !FirstTrue
    - when: !calc doc.platform.name=="THEIA"
      do: "mpirun -np $ncmd"
    - when: !calc doc.platform.name=="WCOSS_C"
      do: "aprun -j 1 -n \\$ncmd -N 1 -d {NTHREADS_CALCINC} -cc depth"
    - otherwise: !error "No APRUN_CALCINC for unknown platform {doc.platform.name}"
  NTHREADS_CALCINC: 1

  APRUN_GSI:  !calc tools.command_without_exe(par,run_gsi.resources,"placeholder")
  ANALYSISSH: !expand "{doc.places.BASE_GSI}/scripts/exglobal_analysis_fv3gfs.sh.ecf"
  NTHREADS_GSI: !calc nodes.omp_threads_for(anal_resources[0])
  CASE_ENKF: !calc doc.fv3_enkf_settings.CASE

  VERBOSE: YES

anal_gdas_action: &anal_gdas_action !Action
  <<: [ *gfs_output_settings, *fv3_gdas_settings, *data_assimilation, *anal_base ]
  CDUMP: gdas
  Template: null
  Inherit: !Inherit
    - [ doc.platform.general_env,  ".*" ]
    - [ doc.gfs_output_settings, "^FH.*|OUTPUT_GRID" ]
    - [ doc.platform.mpi_tuning, '.*' ]
    - [ doc.fv3_enkf_settings, "FHCYC" ]
    - [ doc.fv3_settings, "LEVS|QUILTING|WRITE_NEMSIOFILE|nst_anl" ]
    - [ doc.case, "EDATE|SDATE|gfs_cyc" ]

anal_gfs_action: &anal_gfs_action !Action
  <<: [ *gfs_output_settings, *fv3_gfs_settings, *data_assimilation, *anal_base ]
  CDUMP: gfs
  Template: null
  Inherit: !Inherit
    - [ doc.platform.general_env,  ".*" ]
    - [ doc.gfs_output_settings, "^FH.*|OUTPUT_GRID" ]
    - [ doc.platform.mpi_tuning, '.*' ]
    - [ doc.fv3_enkf_settings, "FHCYC" ]
    - [ doc.fv3_settings, "LEVS|QUILTING|WRITE_NEMSIOFILE|nst_anl" ]
    - [ doc.case, "EDATE|SDATE|gfs_cyc" ]

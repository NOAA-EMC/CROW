scheduler_settings:
  name: LSFAlps
  physical_cores_per_node: 24
  logical_cpus_per_core: 2
  hyperthreading_allowed: true
  
scheduler: !calc |
  tools.get_scheduler(doc.scheduler_settings.name,
                      doc.scheduler_settings)

shared_accounting: &shared_accounting
  queue: !calc metasched.varref('QUEUESERV')
  project: !calc metasched.varref('PROJECT')

exclusive_accounting: &exclusive_accounting
  queue: !calc metasched.varref('QUEUE')
  project: !calc metasched.varref('PROJECT')

ecf_file_template: &ecf_file_template !expand |
  #! /bin/sh
  {sched.batch_accounting(accounting,jobname=task_path_var,outerr="%ECF_OUT%/"+task_path_var+"_t"+"%CYC%"+"z.log")
  }{sched.batch_resources(resources)}
  %include <head.h>
  echo ${{JOBgfs}}/{J_JOB}
  %include <tail.h>

suite: !Cycle
  Clock: !Clock
    start: 2018-01-01T00:00:00
    end: 2018-01-01T18:00:00
    step: !timedelta "6:00:00"

  ecFlow:
    suite_def_filename: "prod%H.def"
    suite_name: "prod%H"
    scheduler: !calc doc.scheduler

  Rocoto: *Rocoto

  ecflow_def: !expand |
    repeat day 1
    edit ECF_TRIES '1'
    #edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% xc40-dev'
    edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% %MACHINE%'
    edit ECF_KILL_CMD 'lkill %ECF_NAME% %ECF_JOBOUT%'
    edit ECF_HOME '{doc.settings.ECF_HOME}'
    #edit ECF_HOME '/gpfs/hps3/emc/global/noscrub/emc.glopara/ecflow/fv3'
    edit CYC '{tools.strftime(suite.Clock.now,"%H")}'
    edit ENVIR 'prod'
    edit E 'jecffv3'
    #edit QUEUE 'dev'
    edit QUEUE '{doc.settings.QUEUE}'
    edit PROJENVIR '{doc.settings.PROJECT}'
    edit EMCPEN 'ecfgfsfv3'
    edit COM '/gpfs/hps2/ptmp/emc.glopara/%EMCPEN%/com'
    edit QUEUESERV '{doc.settings.QUEUESERV}'
    edit DATAROOT '/gpfs/hps2/stmp/emc.glopara/%EMCPEN%'
    edit ECF_FILES '{doc.settings.ECF_HOME}/scripts'
    edit ECF_OUT '{doc.settings.ECF_HOME}/output'
    edit ECF_LOG '{doc.settings.ECF_HOME}/ecf.log'

  gdas: !Family
    ecflow_def: |
      edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% %MACHINE%'
      edit ECF_FILES '{doc.settings.ECF_HOME}/scripts'
      edit PROJ '%PROJENVIR%'

    jgdas_verfrad: !Task
      Trigger: !Depend enkf
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_nothing )
      accounting: *exclusive_accounting
      J_JOB: nothing
      Rocoto: *rocoto_task_template

    jgdas_vminmon: !Task
      Trigger: !Depend jgdas_analysis
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_nothing )
      accounting: *exclusive_accounting
      J_JOB: nothing
      Rocoto: *rocoto_task_template

    dump: !Family
      jgdas_ics: !Task
        release_gdas00_ics: !DataEvent {file="/dev/null"}
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_nothing )
        accounting: *exclusive_accounting
        J_JOB: nothing
        Rocoto: *rocoto_task_template

      #jgdas_dump_post: !Task
      #  Trigger: !Depend jgdas_dump
      #  release_sfcprep: !DataEvent {file="/dev/null"}
      #  release_gdas00_dump_alert: !DataEvent {file="/dev/null"}
      #  ecf_file: *ecf_file_template
      #  resources: !calc ( doc.resource_demo.run_nothing )
      #  accounting: *exclusive_accounting
      #  J_JOB: nothing
 
      jgdas_tropcy_qc_reloc: !Task
        Trigger: !Depend jgdas_dump
        #Time: !timedelta +5:50:00
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_nothing )
        accounting: *exclusive_accounting
        J_JOB: nothing
        Rocoto: *rocoto_task_template

      #Replaced by emc version of dump job 
      #This dump job should be using NCO version when delivery to NCO
      jgdas_dump: !Task
        release_sfcprep: !DataEvent {file="/dev/null"}
        #Time: !timedelta +6:20:00
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_nothing )
        accounting: *exclusive_accounting
        J_JOB: nothing
        Rocoto: *rocoto_task_template

    prep: !Family
      jgdas_emcsfc_sfc_prep: !Task
        Trigger: !Depend up.dump.jgdas_dump.release_sfcprep
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_nothing )
        accounting: *exclusive_accounting
        J_JOB: nothing
        Rocoto: *rocoto_task_template

      jgdas_prep: !Task
        #Trigger: !Depend (up.dump.jgdas_dump & up.dump.jgdas_tropcy_qc_reloc & up.gdas.post.at('-6:00:00') )
        Trigger: !Depend ( up.dump.jgdas_dump & up.dump.jgdas_tropcy_qc_reloc )
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_prep )
        accounting: *exclusive_accounting
        J_JOB: prep
        Rocoto: *rocoto_task_template

      jgdas_prep_post: !Task
        Trigger: !Depend up.jgdas_analysis
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_nothing )
        accounting: *exclusive_accounting
        J_JOB: nothing
        Rocoto: *rocoto_task_template

    enkf: !Family
      jgdas_enkf_select_obs: !Task
        Trigger: !Depend  ( up.prep.jgdas_prep & jgdas_enkf_post.at('-6:00:00') )
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_eobs )
        accounting: *exclusive_accounting
        J_JOB: eobs
        Rocoto: *rocoto_task_template

      innovate: !TaskArray
        Trigger: !Depend jgdas_enkf_select_obs
        Dimensions:
          groupid: !calc tools.seq(1,8,1)
        grp: !TaskElement
          Foreach: [ group ]
          Name: !expand "grp{idx.groupid}"
          ecf_file: *ecf_file_template
          resources: !calc ( doc.resource_demo.run_eomg )
          accounting: *exclusive_accounting
          J_JOB: eomg
          Rocoto: *rocoto_task_template

      jgdas_enkf_update: !Task
        ecflow_def: |
          edit ECF_PASS 'FREE'
        Trigger: !Depend innovate
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_eupd )
        accounting: *exclusive_accounting
        J_JOB: eupd
        Rocoto: *rocoto_task_template

      jgdas_enkf_inflate_recenter: !Task
        Trigger: !Depend ( jgdas_enkf_update & up.jgdas_analysis )
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_ecen )
        accounting: *exclusive_accounting
        J_JOB: ecen
        Rocoto: *rocoto_task_template

      forecast: !TaskArray
        Trigger: !Depend up.enkf.jgdas_enkf_inflate_recenter
        Dimensions:
          groupid: !calc tools.seq(1,8,1)
        grp: !TaskElement
          Foreach: [ group ]
          Name: !expand "grp{idx.groupid}"
          ecf_file: *ecf_file_template
          resources: !calc ( doc.resource_demo.run_efcs )
          accounting: *exclusive_accounting
          J_JOB: efcs
          Rocoto: *rocoto_task_template
          
      jgdas_enkf_post: !Task
        Trigger: !Depend forecast
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_epos )
        accounting: *exclusive_accounting
        J_JOB: epos
        Rocoto: *rocoto_task_template


    jgdas_analysis: !Task
      Trigger: !Depend ( prep.jgdas_prep & prep.jgdas_emcsfc_sfc_prep & enkf.jgdas_enkf_post.at('-6:00:00') )
      release_fcst: !DataEvent {file="/dev/null"}
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_anal )
      accounting: *exclusive_accounting
      J_JOB: anal
      Rocoto: *rocoto_task_template

    jgdas_forecast: !Task
      Trigger: !Depend ( jgdas_analysis.release_fcst & enkf.innovate )
      release_fcst: !DataEvent {file="/dev/null"}
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_gdasfcst )
      accounting: *exclusive_accounting
      J_JOB: fcst
      Rocoto: *rocoto_task_template

    post: !Task
      Trigger: !Depend jgdas_forecast
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_gdaspost )
      accounting: *exclusive_accounting
      J_JOB: post
      Rocoto: *rocoto_task_template

    vrfy: !Task
      Trigger: !Depend post
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_vrfy )
      accounting: *exclusive_accounting
      J_JOB: vrfy
      Rocoto: *rocoto_task_template

  gfs: !Family
    ecflow_def: |
      edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% xc40-dev'
      edit PROJ '%PROJENVIR%'

    dump: !Family
      jgfs_tropcy_qc_reloc: !Task
        Trigger: !Depend jgfs_dump
        jtwc_bull_email: !DataEvent {file="/dev/null"}
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_nothing )
        accounting: *exclusive_accounting
        J_JOB: nothing
        Rocoto: *rocoto_task_template

      #Replaced by emc version of dump job 
      #This dump job should be using NCO version when delivery to NCO
      jgfs_dump: !Task
        release_sfcprep: !DataEvent {file="/dev/null"}
        #Time: !timedelta +3:50:00
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_nothing )
        accounting: *exclusive_accounting
        J_JOB: nothing
        Rocoto: *rocoto_task_template

    prep: !Family
      jgfs_emcsfc_sfc_prep: !Task
        Trigger: !Depend up.dump.jgfs_dump.release_sfcprep
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_nothing )
        accounting: *exclusive_accounting
        J_JOB: nothing
        Rocoto: *rocoto_task_template
    
      jgfs_prep: !Task
        Trigger: !Depend up.dump
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_prep )
        accounting: *exclusive_accounting
        J_JOB: prep
        Rocoto: *rocoto_task_template

      jgfs_prep_post: !Task
        Trigger: !Depend  up.jgfs_analysis
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_nothing )
        accounting: *exclusive_accounting
        J_JOB: nothing
        Rocoto: *rocoto_task_template

    jgfs_analysis: !Task
      Trigger: !Depend ( prep.jgfs_prep & prep.jgfs_emcsfc_sfc_prep  & up.gdas.enkf.jgdas_enkf_post.at('-6:00:00') )
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_anal )
      accounting: *exclusive_accounting
      J_JOB: anal
      Rocoto: *rocoto_task_template

    jgfs_vminmon: !Task
      Trigger: !Depend jgfs_analysis
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_nothing )
      accounting: *exclusive_accounting
      J_JOB: nothing
      Rocoto: *rocoto_task_template

    jgfs_forecast: !Task
      Trigger: !Depend jgfs_analysis
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_gfsfcst )
      accounting: *exclusive_accounting
      J_JOB: fcst
      Rocoto: *rocoto_task_template

    jgfs_post: !Task
      Trigger: !Depend jgfs_forecast
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_gfspost )
      accounting: *exclusive_accounting
      J_JOB: post
      Rocoto: *rocoto_task_template
    
    jgfs_vrfy: !Task
      Trigger: !Depend jgfs_post
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_vrfy )
      accounting: *exclusive_accounting
      J_JOB: vrfy
      Rocoto: *rocoto_task_template

  archive: !Family
    gdasarch: !Task
      Trigger: !Depend up.gdas.jgdas_verfrad
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_arch )
      accounting: *shared_accounting
      J_JOB: gdasarch
      Rocoto: *rocoto_task_template

    gfsarch: !Task
      Trigger: !Depend up.gfs.jgfs_vrfy
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_arch )
      accounting: *shared_accounting
      J_JOB: gfsarch
      Rocoto: *rocoto_task_template

    earc: !TaskArray
      Trigger: !Depend up.gdas.enkf.jgdas_enkf_post
      Dimensions:
        groupid: !calc tools.seq(1,8,1)
      grp: !TaskElement
        Foreach: [ group ]
        Name: !expand "grp{idx.groupid}"
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_arch )
        accounting: *shared_accounting
        J_JOB: earc
        Rocoto: *rocoto_task_template

  final: !Task
    ecf_file: *ecf_file_template
    resources: !calc ( doc.resource_demo.run_nothing )
    accounting: *shared_accounting
    J_JOB: final
    Rocoto: *rocoto_task_template


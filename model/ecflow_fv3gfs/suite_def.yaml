scheduler_settings:
  name: LSFAlps
  physical_cores_per_node: 24
  logical_cpus_per_core: 2
  hyperthreading_allowed: true
  
scheduler: !calc |
  tools.get_scheduler(doc.scheduler_settings.name,
                      doc.scheduler_settings)

settings:
  NMEM_ENKF: 80
  ECF_HOME: '/gpfs/hps3/emc/hwrf/noscrub/Bin.Liu/save/gitCROW/model/ecflow_fv3gfs'

shared_accounting: &shared_accounting
  queue: '%QUEUESERV%' 
  project: '%PROJECT%'

exclusive_accounting: &exclusive_accounting
  queue: '%QUEUE%'
  project: '%PROJECT%'

ecf_file_template: &ecf_file_template !expand |
  #! /bin/sh
  {sched.batch_accounting(accounting,jobname=task_path_var,outerr="%ECF_OUT%/"+task_path_var+"_t"+"%CYC%"+"z.log")
  }{sched.batch_resources(resources)}
  %include <head.h>
  echo ${{JOBgfs}}/{J_JOB}
  %include <tail.h>

suite: !Cycle
  Clock: !Clock
    start: 2018-01-01T00:00:00
    end: 2018-01-01T18:00:00
    step: !timedelta "6:00:00"

  ecFlow:
    suite_def_filename: "prod%H.def"
    suite_name: "prod%H"
    scheduler: !calc doc.scheduler

  ecflow_def: !expand |
    repeat day 1
    edit ECF_TRIES '1'
    edit QUEUE 'debug'
    edit QUEUESERV 'dev_transfer'
    edit MACHINE 'xc40-dev'
    edit PROJECT 'HUR-T2O'
    edit ECF_HOME '{doc.settings.ECF_HOME}'
    edit PROJENVIR 'HUR-T2O'
    edit EMCPEN 'ecfgfsfv3'
    edit CYC '{tools.strftime(suite.Clock.now,"%H")}'
    edit COM '/gpfs/hps2/ptmp/emc.glopara/%EMCPEN%/com'
    edit QUEUESERV 'dev_transfer'
    edit DATAROOT '/gpfs/hps2/stmp/emc.glopara/%EMCPEN%'
    edit ECF_FILES '{doc.settings.ECF_HOME}/scripts'
    edit ECF_OUT '{doc.settings.ECF_HOME}/output'
    edit ECF_LOG '{doc.settings.ECF_HOME}/ecf.log'

  gdas: !Family
    prep: !Task
      Trigger: !Depend  up.gdas.post.at('-6:00:00')
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_prep )
      accounting: *exclusive_accounting
      J_JOB: prep

    enkf: !Family
      eobs: !Task
        Trigger: !Depend  ( up.prep & epos.at('-6:00:00') )
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_eobs )
        accounting: *exclusive_accounting
        J_JOB: eobs

      eomg: !Family
        Trigger: !Depend eobs
        grp1: !Task
          ecf_file: *ecf_file_template
          resources: !calc ( doc.resource_demo.run_eomg )
          accounting: *exclusive_accounting
          J_JOB: eomg

        grp2: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=20 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_eomg ) 
              accounting: *exclusive_accounting
              J_JOB: eomg
          - otherwise: null

        grp3: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=30 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_eomg )
              accounting: *exclusive_accounting
              J_JOB: eomg
          - otherwise: null

        grp4: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=40 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_eomg )
              accounting: *exclusive_accounting
              J_JOB: eomg
          - otherwise: null

        grp5: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=50 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_eomg )
              accounting: *exclusive_accounting
              J_JOB: eomg
          - otherwise: null

        grp6: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=60 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_eomg )
              accounting: *exclusive_accounting
              J_JOB: eomg
          - otherwise: null

        grp7: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=70 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_eomg )
              accounting: *exclusive_accounting
              J_JOB: eomg
          - otherwise: null

        grp8: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=80 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_eomg )
              accounting: *exclusive_accounting
              J_JOB: eomg
          - otherwise: null

      eupd: !Task
        Trigger: !Depend eomg
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_eupd )
        accounting: *exclusive_accounting
        J_JOB: eupd

      ecen: !Task
        Trigger: !Depend ( eupd & up.anal )
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_ecen )
        accounting: *exclusive_accounting
        J_JOB: ecen

#      efcs: !TaskArray
#        Trigger: !Depend ecen
#        Indices:
#          GROUP_NUMBER_INDEX: [ 1, 2, 3, 4, 5, 6, 7, 8 ]
#          OTHER_INDEX: [ a, b, c, d ]
#        Names: 
#          grp: !expand grp{indices.GROUP_NUMBER_INDEX:%d}_{indices.OTHER_INDEX}
#          other: !expand other{indices.OTHER_INDEX}_{indices.GROUP_NUMBER_INDEX}
#        Contents:
#          other: !Task
#            ...
#          grp: !Task 
#            Perform:  
#              <<: *efcs_action
#              NMEM_ENKF: *NMEM_ENKF
#              NMEM_ENKF_GRP_EFMN: *NMEM_ENKF_GRP_EFMN
#              GROUP_NUMBER: !calc indices.GROUP_NUMBER_INDEX   # Convert to ENSGRP %02d
#            task_template: *task_template
#            ens_more: *ens_task_template
#            Rocoto: !expand "{task_template}{ens_more}"

      efcs: !Family
        Trigger: !Depend ecen
        grp1: !Task
          ecf_file: *ecf_file_template
          resources: !calc ( doc.resource_demo.run_efcs )
          accounting: *exclusive_accounting
          J_JOB: efcs


        grp2: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=20 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_efcs )
              accounting: *exclusive_accounting
              J_JOB: efcs
          - otherwise: null

        grp3: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=30 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_efcs )
              accounting: *exclusive_accounting
              J_JOB: efcs
          - otherwise: null

        grp4: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=40 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_efcs )
              accounting: *exclusive_accounting
              J_JOB: efcs
          - otherwise: null

        grp5: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=50 )"
            do: !Task
              ecf_file: *ecf_file_template
              J_JOB: efcs
              resources: !calc ( doc.resource_demo.run_efcs )
              accounting: *exclusive_accounting
          - otherwise: null

        grp6: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=60 )"
            do: !Task
              ecf_file: *ecf_file_template
              J_JOB: efcs
              resources: !calc ( doc.resource_demo.run_efcs )
              accounting: *exclusive_accounting
          - otherwise: null

        grp7: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=70 )"
            do: !Task
              ecf_file: *ecf_file_template
              J_JOB: efcs
              resources: !calc ( doc.resource_demo.run_efcs )
              accounting: *exclusive_accounting
          - otherwise: null

        grp8: !FirstTrue
          - when: !calc "( doc.settings.NMEM_ENKF>=80 )"
            do: !Task
              ecf_file: *ecf_file_template
              resources: !calc ( doc.resource_demo.run_efcs )
              accounting: *exclusive_accounting
              J_JOB: efcs
          - otherwise: null

      epos: !Task
        Trigger: !Depend efcs
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_epos )
        accounting: *exclusive_accounting
        J_JOB: epos

    anal: !Task
      Trigger: !Depend  ( prep & enkf.epos.at('-6:00:00') )
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_anal )
      accounting: *exclusive_accounting
      J_JOB: anal

    fcst: !Task
      Trigger: !Depend anal
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_gdasfcst )
      accounting: *exclusive_accounting
      J_JOB: fcst

    post: !Task
      Trigger: !Depend fcst
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_gdaspost )
      accounting: *exclusive_accounting
      J_JOB: post

    vrfy: !Task
      Trigger: !Depend post
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_vrfy )
      accounting: *exclusive_accounting
      J_JOB: vrfy

  gfs: !Family
    prep: !Task
      Trigger: !Depend  up.gdas.post.at('-6:00:00')
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_prep )
      accounting: *exclusive_accounting
      J_JOB: prep
    
    anal: !Task
      Trigger: !Depend  ( prep & up.gdas.enkf.epos.at('-6:00:00') )
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_anal )
      accounting: *exclusive_accounting
      J_JOB: anal

    fcst: !Task
      Trigger: !Depend anal
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_gfsfcst )
      accounting: *exclusive_accounting
      J_JOB: fcst

    post: !Task
      Trigger: !Depend fcst
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_gfspost )
      accounting: *exclusive_accounting
      J_JOB: post
    
    vrfy: !Task
      Trigger: !Depend post
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_vrfy )
      accounting: *exclusive_accounting
      J_JOB: vrfy

  archive: !Family
    gdasarch: !Task
      Trigger: !Depend up.gdas.vrfy
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_arch )
      accounting: *shared_accounting
      J_JOB: gdasarch

    gfsarch: !Task
      Trigger: !Depend up.gfs.vrfy
      ecf_file: *ecf_file_template
      resources: !calc ( doc.resource_demo.run_arch )
      accounting: *shared_accounting
      J_JOB: gfsarch

    earc: !Family
      Trigger: !Depend up.gdas.enkf.epos
      grp1: !Task
        ecf_file: *ecf_file_template
        resources: !calc ( doc.resource_demo.run_arch )
        accounting: *shared_accounting
        J_JOB: earc
      grp2: !FirstTrue
        - when: !calc "( doc.settings.NMEM_ENKF>=20 )"
          do: !Task
            ecf_file: *ecf_file_template
            resources: !calc ( doc.resource_demo.run_arch )
            accounting: *shared_accounting
            J_JOB: earc
        - otherwise: null
      grp3: !FirstTrue
        - when: !calc "( doc.settings.NMEM_ENKF>=30 )"
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: !calc ( doc.resource_demo.run_arch )
            accounting: *shared_accounting
        - otherwise: null
      grp4: !FirstTrue
        - when: !calc "( doc.settings.NMEM_ENKF>=40 )"
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: !calc ( doc.resource_demo.run_arch )
            accounting: *shared_accounting
        - otherwise: null
      grp5: !FirstTrue
        - when: !calc "( doc.settings.NMEM_ENKF>=50 )"
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: !calc ( doc.resource_demo.run_arch )
            accounting: *shared_accounting
        - otherwise: null
      grp6: !FirstTrue
        - when: !calc "( doc.settings.NMEM_ENKF>=60 )"
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: !calc ( doc.resource_demo.run_arch )
            accounting: *shared_accounting
        - otherwise: null
      grp7: !FirstTrue
        - when: !calc "( doc.settings.NMEM_ENKF==70 )"
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: !calc ( doc.resource_demo.run_arch )
            accounting: *shared_accounting
        - otherwise: null
      grp7: !FirstTrue
        - when: !calc "( doc.settings.NMEM_ENKF>=70 )"
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: !calc ( doc.resource_demo.run_arch )
            accounting: *shared_accounting
        - otherwise: null
      grp8: !FirstTrue
        - when: !calc "( doc.settings.NMEM_ENKF>=80 )"
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            accounting: *shared_accounting
            resources: !calc ( doc.resource_demo.run_arch )
        - otherwise: null

  #final: !Task
  #  ecf_file: *ecf_file_template
  #  resources: *sample_shared_serial
  #  accounting: *shared_accounting
  #  J_JOB: final


scheduler_settings:
  name: LSFAlps
  physical_cores_per_node: 24
  logical_cpus_per_core: 2
  hyperthreading_allowed: true
  
scheduler: !calc |
  tools.get_scheduler(doc.scheduler_settings.name,
                      doc.scheduler_settings)

sample_mpi_omp: &sample_mpi_omp !JobRequest
  - exe: placeholder
    mpi_ranks: 24
    OMP_NUM_THREADS: 2
    walltime: 00:05:00

sample_shared_serial: &sample_shared_serial !JobRequest
  - exe: placeholder
    walltime: 00:05:00
    exclusive: false

settings:
  NMEM_ENKF: 80

accounting:
  queue: '%QUEUE%'
  project: GFS-T2O

ecf_file_template: &ecf_file_template !expand |
  #! /bin/sh
  {sched.batch_accounting(doc.accounting,jobname=task_path_var,outerr="%LOG%"+task_path_var+".log")
  }{sched.batch_resources(resources)}
  %include <head.h>
  echo ${{JOBgfs}}/{J_JOB}
  %include <tail.h>

suite: !Cycle
  Clock: !Clock
    start: 2018-01-01T00:00:00
    end: 2018-01-01T18:00:00
    step: !timedelta "6:00:00"

  ecFlow:
    suite_def_filename: "prod%H.def"
    suite_name: "prod%H"
    scheduler: !calc doc.scheduler

  gdas: !Family
    prep: !Task
      Trigger: !Depend  up.gdas.post.at('-6:00:00')
      ecf_file: *ecf_file_template
      resources: *sample_mpi_omp
      J_JOB: prep

    enkf: !Family
      eobs: !Task
        Trigger: !Depend  ( up.prep & epos.at('-6:00:00') )
        ecf_file: *ecf_file_template
        resources: *sample_mpi_omp
        J_JOB: eobs

      eomg: !Family
        Trigger: !Depend eobs
        grp1: !Task
          ecf_file: *ecf_file_template
          resources: *sample_mpi_omp
          J_JOB: eomg

        grp2: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==20
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: eomg
          - otherwise: null

        grp3: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==30
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: eomg
          - otherwise: null

        grp4: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==40
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: eomg
          - otherwise: null

        grp5: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==50
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: eomg
          - otherwise: null

        grp6: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==60
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: eomg
          - otherwise: null

        grp7: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==70
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: eomg
          - otherwise: null

        grp8: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==80
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: eomg
          - otherwise: null

      eupd: !Task
        Trigger: !Depend eomg
        ecf_file: *ecf_file_template
        resources: *sample_mpi_omp
        J_JOB: eupd

      ecen: !Task
        Trigger: !Depend ( eupd & up.anal )
        ecf_file: *ecf_file_template
        resources: *sample_mpi_omp
        J_JOB: ecen

#      efcs: !TaskArray
#        Trigger: !Depend ecen
#        Indices:
#          GROUP_NUMBER_INDEX: [ 1, 2, 3, 4, 5, 6, 7, 8 ]
#          OTHER_INDEX: [ a, b, c, d ]
#        Names: 
#          grp: !expand grp{indices.GROUP_NUMBER_INDEX:%d}_{indices.OTHER_INDEX}
#          other: !expand other{indices.OTHER_INDEX}_{indices.GROUP_NUMBER_INDEX}
#        Contents:
#          other: !Task
#            ...
#          grp: !Task 
#            Perform:  
#              <<: *efcs_action
#              NMEM_ENKF: *NMEM_ENKF
#              NMEM_ENKF_GRP_EFMN: *NMEM_ENKF_GRP_EFMN
#              GROUP_NUMBER: !calc indices.GROUP_NUMBER_INDEX   # Convert to ENSGRP %02d
#            task_template: *task_template
#            ens_more: *ens_task_template
#            Rocoto: !expand "{task_template}{ens_more}"

      efcs: !Family
        Trigger: !Depend ecen
        grp1: !Task
          ecf_file: *ecf_file_template
          resources: *sample_mpi_omp
          J_JOB: efcs


        grp2: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==20
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: efcs
          - otherwise: null

        grp3: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==30
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: efcs
          - otherwise: null

        grp4: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==40
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: efcs
          - otherwise: null

        grp5: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==50
            do: !Task
              ecf_file: *ecf_file_template
              J_JOB: efcs
              resources: *sample_mpi_omp
          - otherwise: null

        grp6: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==60
            do: !Task
              ecf_file: *ecf_file_template
              J_JOB: efcs
              resources: *sample_mpi_omp
          - otherwise: null

        grp7: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==70
            do: !Task
              ecf_file: *ecf_file_template
              J_JOB: efcs
              resources: *sample_mpi_omp
          - otherwise: null

        grp8: !FirstTrue
          - when: !calc doc.settings.NMEM_ENKF==80
            do: !Task
              ecf_file: *ecf_file_template
              resources: *sample_mpi_omp
              J_JOB: efcs
          - otherwise: null

      epos: !Task
        Trigger: !Depend efcs
        ecf_file: *ecf_file_template
        resources: *sample_mpi_omp
        J_JOB: epos

    anal: !Task
      Trigger: !Depend  ( prep & enkf.epos.at('-6:00:00') )
      ecf_file: *ecf_file_template
      resources: *sample_mpi_omp
      J_JOB: anal

    fcst: !Task
      Trigger: !Depend anal
      ecf_file: *ecf_file_template
      resources: *sample_mpi_omp
      J_JOB: fcst

    post: !Task
      Trigger: !Depend fcst
      ecf_file: *ecf_file_template
      resources: *sample_mpi_omp
      J_JOB: post

    vrfy: !Task
      Trigger: !Depend post
      ecf_file: *ecf_file_template
      resources: *sample_mpi_omp
      J_JOB: vrfy

  gfs: !Family
    prep: !Task
      Trigger: !Depend  up.gdas.post.at('-6:00:00')
      ecf_file: *ecf_file_template
      resources: *sample_mpi_omp
      J_JOB: prep
    
    anal: !Task
      Trigger: !Depend  ( prep & up.gdas.enkf.epos.at('-6:00:00') )
      ecf_file: *ecf_file_template
      resources: *sample_mpi_omp
      J_JOB: anal

    fcst: !Task
      Trigger: !Depend anal
      ecf_file: *ecf_file_template
      resources: *sample_mpi_omp
      J_JOB: fcst

    post: !Task
      Trigger: !Depend fcst
      ecf_file: *ecf_file_template
      resources: *sample_mpi_omp
      J_JOB: post
    
    vrfy: !Task
      Trigger: !Depend post
      ecf_file: *ecf_file_template
      resources: *sample_mpi_omp
      J_JOB: vrfy

  archive: !Family
    gdasarch: !Task
      Trigger: !Depend up.gdas.vrfy
      ecf_file: *ecf_file_template
      resources: *sample_shared_serial
      J_JOB: gdasarch

    gfsarch: !Task
      Trigger: !Depend up.gfs.vrfy
      ecf_file: *ecf_file_template
      resources: *sample_shared_serial
      J_JOB: gfsarch

    earc: !Family
      Trigger: !Depend up.gdas.enkf.epos
      grp1: !Task
        ecf_file: *ecf_file_template
        resources: *sample_shared_serial
        J_JOB: earc
      grp2: !FirstTrue
        - when: !calc doc.settings.NMEM_ENKF==20
          do: !Task
            ecf_file: *ecf_file_template
            resources: *sample_shared_serial
            J_JOB: earc
        - otherwise: null
      grp3: !FirstTrue
        - when: !calc doc.settings.NMEM_ENKF==30
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: *sample_shared_serial
        - otherwise: null
      grp4: !FirstTrue
        - when: !calc doc.settings.NMEM_ENKF==40
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: *sample_shared_serial
        - otherwise: null
      grp5: !FirstTrue
        - when: !calc doc.settings.NMEM_ENKF==50
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: *sample_shared_serial
        - otherwise: null
      grp6: !FirstTrue
        - when: !calc doc.settings.NMEM_ENKF==60
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: *sample_shared_serial
        - otherwise: null
      grp7: !FirstTrue
        - when: !calc doc.settings.NMEM_ENKF==70
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: *sample_shared_serial
        - otherwise: null
      grp8: !FirstTrue
        - when: !calc doc.settings.NMEM_ENKF==80
          do: !Task
            ecf_file: *ecf_file_template
            J_JOB: earc
            resources: *sample_shared_serial
        - otherwise: null

  final: !Task
    ecf_file: *ecf_file_template
    resources: *sample_shared_serial
    J_JOB: final


wcoss_cray_scheduler_settings:
  name: LSFAlps
  physical_cores_per_node: 24
  logical_cpus_per_core: 2
  hyperthreading_allowed: true

theia_scheduler_settings:
  name: MoabTorque
  physical_cores_per_node: 24
  logical_cpus_per_core: 2
  hyperthreading_allowed: true
  
scheduler_settings: !calc wcoss_cray_scheduler_settings

scheduler: !calc |
  tools.get_scheduler(doc.scheduler_settings.name,
                      doc.scheduler_settings)

shared_accounting: &shared_accounting
  queue: !calc metasched.varref('QUEUESERV')
  project: !calc metasched.varref('PROJECT')

exclusive_accounting: &exclusive_accounting
  queue: !calc metasched.varref('QUEUE')
  project: !calc metasched.varref('PROJECT')

ecf_file_template: &ecf_file_template !expand |
  #! /bin/sh
  {sched.batch_accounting(accounting,jobname=task_path_var,outerr="%ECF_OUT%/"+task_path_var+"_t"+"%CYC%"+"z.log")
  }{sched.batch_resources(resources)}
  %include <head.h>
  echo ${{JOBgfs}}/{J_JOB}
  %include <tail.h>

shared_task_template: &shared_task_template
  ecf_file: *ecf_file_template
  accounting: *shared_accounting
  J_JOB: !calc tools.to_upper(task_path_var[-1])
  Rocoto: *rocoto_task_template

exclusive_task_template: &exclusive_task_template
  ecf_file: *ecf_file_template
  accounting: *exclusive_accounting
  J_JOB: !calc tools.to_upper(task_path_var[-1])
  Rocoto: *rocoto_task_template

suite: !Cycle
  Clock: !Clock
    start: 2018-01-01T00:00:00
    end: 2018-01-01T18:00:00
    step: !timedelta "6:00:00"

  ecFlow:
    suite_def_filename: "prod%H.def"
    suite_name: "prod%H"
    scheduler: !calc doc.scheduler

  Rocoto: *Rocoto

  ecflow_def: !expand |
    repeat day 1
    edit ECF_TRIES '1'
    #edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% xc40-dev'
    edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% %MACHINE%'
    edit ECF_KILL_CMD 'lkill %ECF_NAME% %ECF_JOBOUT%'
    edit ECF_HOME '{doc.settings.ECF_HOME}'
    #edit ECF_HOME '/gpfs/hps3/emc/global/noscrub/emc.glopara/ecflow/fv3'
    edit CYC '{tools.strftime(suite.Clock.now,"%H")}'
    edit ENVIR 'prod'
    edit E 'jecffv3'
    #edit QUEUE 'dev'
    edit QUEUE '{doc.settings.QUEUE}'
    edit PROJENVIR '{doc.settings.PROJECT}'
    edit EMCPEN 'ecfgfsfv3'
    edit COM '/gpfs/hps2/ptmp/emc.glopara/%EMCPEN%/com'
    edit QUEUESERV '{doc.settings.QUEUESERV}'
    edit DATAROOT '/gpfs/hps2/stmp/emc.glopara/%EMCPEN%'
    edit ECF_FILES '{doc.settings.ECF_HOME}/scripts'
    edit ECF_OUT '{doc.settings.ECF_HOME}/output'
    edit ECF_LOG '{doc.settings.ECF_HOME}/ecf.log'

  gdas: !Family
    ecflow_def: |
      edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% %MACHINE%'
      edit ECF_FILES '{doc.settings.ECF_HOME}/scripts'
      edit PROJ '%PROJENVIR%'

    jgdas_verfrad: !Task
      <<: *exclusive_task_template
      Trigger: !Depend enkf
      resources: !calc ( doc.resource_demo.run_nothing )

    jgdas_vminmon: !Task
      <<: *exclusive_task_template
      Trigger: !Depend jgdas_analysis
      resources: !calc ( doc.resource_demo.run_nothing )

    dump: !Family
      jgdas_ics: !Task
        <<: *exclusive_task_template
        release_gdas00_ics: !DataEvent {file="/dev/null"}
        resources: !calc ( doc.resource_demo.run_nothing )

      #jgdas_dump_post: !Task
      #  Trigger: !Depend jgdas_dump
      #  release_sfcprep: !DataEvent {file="/dev/null"}
      #  release_gdas00_dump_alert: !DataEvent {file="/dev/null"}
      #  ecf_file: *ecf_file_template
      #  resources: !calc ( doc.resource_demo.run_nothing )
      #  accounting: *exclusive_accounting
      #  J_JOB: nothing
 
      jgdas_tropcy_qc_reloc: !Task
        <<: *exclusive_task_template
        Trigger: !Depend jgdas_dump
        #Time: !timedelta +5:50:00
        resources: !calc ( doc.resource_demo.run_nothing )

      #Replaced by emc version of dump job 
      #This dump job should be using NCO version when delivery to NCO
      jgdas_dump: !Task
        <<: *exclusive_task_template
        release_sfcprep: !DataEvent {file="/dev/null"}
        #Time: !timedelta +6:20:00
        resources: !calc ( doc.resource_demo.run_nothing )

    prep: !Family
      jgdas_emcsfc_sfc_prep: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.dump.jgdas_dump.release_sfcprep
        resources: !calc ( doc.resource_demo.run_nothing )

      jgdas_prep: !Task
        #Trigger: !Depend (up.dump.jgdas_dump & up.dump.jgdas_tropcy_qc_reloc & up.gdas.post.at('-6:00:00') )
        <<: *exclusive_task_template
        Trigger: !Depend ( up.dump.jgdas_dump & up.dump.jgdas_tropcy_qc_reloc )
        resources: !calc ( doc.resource_demo.run_prep )

      jgdas_prep_post: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.jgdas_analysis
        resources: !calc ( doc.resource_demo.run_nothing )

    enkf: !Family
      jgdas_enkf_select_obs: !Task
        <<: *exclusive_task_template
        Trigger: !Depend  ( up.prep.jgdas_prep & jgdas_enkf_post.at('-6:00:00') )
        resources: !calc ( doc.resource_demo.run_eobs )

      innovate: !TaskArray
        Trigger: !Depend jgdas_enkf_select_obs
        Dimensions:
          groupid: !calc tools.seq(1,8,1)
        grp: !TaskElement
          <<: *exclusive_task_template
          Foreach: [ group ]
          Name: !expand "grp{idx.groupid}"
          resources: !calc ( doc.resource_demo.run_eomg )
          J_JOB: jgdas_innovate

      jgdas_enkf_update: !Task
        <<: *exclusive_task_template
        ecflow_def: |
          edit ECF_PASS 'FREE'
        Trigger: !Depend innovate
        resources: !calc ( doc.resource_demo.run_eupd )

      jgdas_enkf_inflate_recenter: !Task
        <<: *exclusive_task_template
        Trigger: !Depend ( jgdas_enkf_update & up.jgdas_analysis )
        resources: !calc ( doc.resource_demo.run_ecen )

      forecast: !TaskArray
        Trigger: !Depend up.enkf.jgdas_enkf_inflate_recenter
        Dimensions:
          groupid: !calc tools.seq(1,8,1)
        grp: !TaskElement
          <<: *exclusive_task_template
          Foreach: [ group ]
          Name: !expand "grp{idx.groupid}"
          resources: !calc ( doc.resource_demo.run_efcs )
          J_JOB: jgfs_forecast
          
      jgdas_enkf_post: !Task
        <<: *exclusive_task_template
        Trigger: !Depend forecast
        resources: !calc ( doc.resource_demo.run_epos )


    jgdas_analysis: !Task
      <<: *exclusive_task_template
      Trigger: !Depend ( prep.jgdas_prep & prep.jgdas_emcsfc_sfc_prep & enkf.jgdas_enkf_post.at('-6:00:00') )
      release_fcst: !DataEvent {file="/dev/null"}
      resources: !calc ( doc.resource_demo.run_anal )

    jgdas_forecast: !Task
      <<: *exclusive_task_template
      Trigger: !Depend ( jgdas_analysis.release_fcst & enkf.innovate )
      release_fcst: !DataEvent {file="/dev/null"}
      resources: !calc ( doc.resource_demo.run_gdasfcst )

    post: !Task
      <<: *exclusive_task_template
      Trigger: !Depend jgdas_forecast
      resources: !calc ( doc.resource_demo.run_gdaspost )
      J_JOB: post

    vrfy: !Task
      <<: *exclusive_task_template
      Trigger: !Depend post
      resources: !calc ( doc.resource_demo.run_vrfy )
      J_JOB: vrfy

  gfs: !Family
    ecflow_def: |
      edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% xc40-dev'
      edit PROJ '%PROJENVIR%'

    dump: !Family
      jgfs_tropcy_qc_reloc: !Task
        <<: *exclusive_task_template
        Trigger: !Depend jgfs_dump
        jtwc_bull_email: !DataEvent {file="/dev/null"}
        resources: !calc ( doc.resource_demo.run_nothing )

      #Replaced by emc version of dump job 
      #This dump job should be using NCO version when delivery to NCO
      jgfs_dump: !Task
        <<: *exclusive_task_template
        release_sfcprep: !DataEvent {file="/dev/null"}
        #Time: !timedelta +3:50:00
        resources: !calc ( doc.resource_demo.run_nothing )

    prep: !Family
      jgfs_emcsfc_sfc_prep: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.dump.jgfs_dump.release_sfcprep
        resources: !calc ( doc.resource_demo.run_nothing )
    
      jgfs_prep: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.dump
        resources: !calc ( doc.resource_demo.run_prep )

      jgfs_prep_post: !Task
        <<: *exclusive_task_template
        Trigger: !Depend  up.jgfs_analysis
        resources: !calc ( doc.resource_demo.run_nothing )

    jgfs_analysis: !Task
      <<: *exclusive_task_template
      Trigger: !Depend ( prep.jgfs_prep & prep.jgfs_emcsfc_sfc_prep  & up.gdas.enkf.jgdas_enkf_post.at('-6:00:00') )
      resources: !calc ( doc.resource_demo.run_anal )

    jgfs_vminmon: !Task
      <<: *exclusive_task_template
      Trigger: !Depend jgfs_analysis
      resources: !calc ( doc.resource_demo.run_nothing )

    jgfs_forecast: !Task
      <<: *exclusive_task_template
      Trigger: !Depend jgfs_analysis
      resources: !calc ( doc.resource_demo.run_gfsfcst )

    jgfs_post: !Task
      <<: *exclusive_task_template
      Trigger: !Depend jgfs_forecast
      resources: !calc ( doc.resource_demo.run_gfspost )
    
    jgfs_vrfy: !Task
      <<: *exclusive_task_template
      Trigger: !Depend jgfs_post
      resources: !calc ( doc.resource_demo.run_vrfy )

  archive: !Family
    gdasarch: !Task
      <<: *shared_task_template
      Trigger: !Depend up.gdas.jgdas_verfrad
      resources: !calc ( doc.resource_demo.run_arch )
      J_JOB: gdasarch

    gfsarch: !Task
      <<: *shared_task_template
      Trigger: !Depend up.gfs.jgfs_vrfy
      resources: !calc ( doc.resource_demo.run_arch )
      J_JOB: gfsarch

    earc: !TaskArray
      Trigger: !Depend up.gdas.enkf.jgdas_enkf_post
      Dimensions:
        groupid: !calc tools.seq(1,8,1)
      grp: !TaskElement
        <<: *shared_task_template
        Foreach: [ group ]
        Name: !expand "grp{idx.groupid}"
        resources: !calc ( doc.resource_demo.run_arch )
        J_JOB: earc

  final: !Task
    <<: *shared_task_template
    resources: !calc ( doc.resource_demo.run_nothing )


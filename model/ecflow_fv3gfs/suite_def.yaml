wcoss_cray_scheduler_settings:
  name: LSFAlps
  physical_cores_per_node: 24
  logical_cpus_per_core: 2
  hyperthreading_allowed: true

theia_scheduler_settings:
  name: MoabTorque
  physical_cores_per_node: 24
  logical_cpus_per_core: 2
  hyperthreading_allowed: true
  
scheduler_settings: !calc wcoss_cray_scheduler_settings

scheduler: !calc |
  tools.get_scheduler(doc.scheduler_settings.name,
                      doc.scheduler_settings)

shared_accounting: &shared_accounting
  queue: !calc metasched.varref('QUEUESERV')
  project: !calc metasched.varref('PROJECT')

exclusive_accounting: &exclusive_accounting
  queue: !calc metasched.varref('QUEUE')
  project: !calc metasched.varref('PROJECT')

ecf_file_template: &ecf_file_template !expand |
  #! /bin/sh
  {sched.batch_accounting(accounting,jobname=task_path_var,outerr="%ECF_OUT%/"+task_path_var+"_t"+"%CYC%"+"z.log")
  }{sched.batch_resources(resources)}
  %include <head.h>
  echo ${{JOBgfs}}/{J_JOB}
  %include <tail.h>

shared_task_template: &shared_task_template
  ecf_file: *ecf_file_template
  accounting: *shared_accounting
  J_JOB: !calc tools.to_upper(task_path_var[-1])
  Rocoto: *rocoto_task_template

exclusive_task_template: &exclusive_task_template
  ecf_file: *ecf_file_template
  accounting: *exclusive_accounting
  J_JOB: !calc tools.to_upper(task_path_list[-1])
  Rocoto: *rocoto_task_template

suite: !Cycle
  Clock: !Clock
    start: 2018-01-01T00:00:00
    end: 2018-01-01T18:00:00
    step: !timedelta "6:00:00"

  ecFlow:
    suite_def_filename: "prod%H.def"
    suite_name: "prod%H"
    scheduler: !calc doc.scheduler

  Rocoto: *Rocoto

  ecflow_def: !expand |
    repeat day 1
    edit ECF_TRIES '1'
    #edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% xc40-dev'
    edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% %MACHINE%'
    edit ECF_KILL_CMD 'lkill %ECF_NAME% %ECF_JOBOUT%'
    edit ECF_HOME '{doc.settings.ECF_HOME}'
    #edit ECF_HOME '/gpfs/hps3/emc/global/noscrub/emc.glopara/ecflow/fv3'
    edit CYC '{tools.strftime(suite.Clock.now,"%H")}'
    edit ENVIR 'prod'
    edit E 'jecffv3'
    #edit QUEUE 'dev'
    edit QUEUE '{doc.settings.QUEUE}'
    edit PROJENVIR '{doc.settings.PROJECT}'
    edit EMCPEN '{doc.settings.experiment_name}'
    edit COM '{doc.settings.COM}'
    edit QUEUESERV '{doc.settings.QUEUESERV}'
    edit DATAROOT '{doc.settings.DATAROOT}'
    edit ECF_FILES '{doc.settings.ECF_HOME}/scripts'
    edit ECF_OUT '{doc.settings.ECF_HOME}/output'
    edit ECF_LOG '{doc.settings.ECF_HOME}/ecf.log'

  gfs: !Family
    ecflow_def: |
      edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% xc40-dev'
      edit ECF_FILES '{doc.settings.ECF_HOME}/scripts'
      edit PROJ '%PROJENVIR%'

    dump: !Family
      jgfs_tropcy_qc_reloc: !Task
        <<: *exclusive_task_template
        Trigger: !Depend jgfs_dump
        jtwc_bull_email: !DataEvent {file="/dev/null"}
        resources: !calc ( doc.resource_demo.run_nothing )

      #Replaced by emc version of dump job 
      #This dump job should be using NCO version when delivery to NCO
      jgfs_dump: !Task
        <<: *exclusive_task_template
        release_sfcprep: !DataEvent {file="/dev/null"}
        #Time: !timedelta +3:50:00
        resources: !calc ( doc.resource_demo.run_nothing )

    prep: !Family
      jgfs_emcsfc_sfc_prep: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.dump.jgfs_dump.release_sfcprep
        resources: !calc ( doc.resource_demo.run_nothing )
    
      jgfs_prep: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.dump
        #Trigger: !Depend ( up.dump.jgfs_dump & up.dump.jgfs_tropcy_qc_reloc
        resources: !calc ( doc.resource_demo.run_prep )

      jgfs_prep_post: !Task
        <<: *exclusive_task_template
        Trigger: !Depend  up.jgfs_analysis
        resources: !calc ( doc.resource_demo.run_nothing )

    jgfs_analysis: !Task
      <<: *exclusive_task_template
      #Trigger: !Depend ( prep.jgfs_prep & prep.jgfs_emcsfc_sfc_prep  & up.gdas.enkf.jgdas_enkf_post.at('-6:00:00') )
      Trigger: !Depend ( prep.jgfs_prep & prep.jgfs_emcsfc_sfc_prep )
      resources: !calc ( doc.resource_demo.run_anal )

    jgfs_vminmon: !Task
      <<: *exclusive_task_template
      Trigger: !Depend jgfs_analysis
      resources: !calc ( doc.resource_demo.run_nothing )

    forecast: !Family
      jgfs_forecast_high: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.jgfs_analysis
        resources: !calc ( doc.resource_demo.run_gfsfcst )
        J_JOB: JGLOBAL_FORECAST

      jgfs_forecast_low: !Task
        <<: *exclusive_task_template
        Trigger: !Depend jgfs_forecast_high
        resources: !calc ( doc.resource_demo.run_gfsfcst )
        J_JOB: JGLOBAL_FORECAST

    sminit_guam: !Family
      jgfs_sminit_guam_even: !Task
        <<: *exclusive_task_template
        #Trigger: !Depend ( up.post.jgfs_post_anl.is_running() or up.post.jgfs_post_anl )
        Trigger: !Depend ( up.post )
        resources: !calc ( doc.resource_demo.run_nothing )

      jgfs_sminit_guam_odd: !Task
        <<: *exclusive_task_template
        #Trigger: !Depend ( up.post.jgfs_post_anl.isrunning() or up.post.jgfs_post_anl )
        Trigger: !Depend ( up.post )
        resources: !calc ( doc.resource_demo.run_nothing )

    post_processing: !Family
      #This is a dummy task as a placeholder
      dummy: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.forecast
        resources: !calc ( doc.resource_demo.run_nothing )

#     jgfs_wafs_gcip: !Task
#       <<: *exclusive_task_template
#       Trigger: !Depend up.prdgen.jgfs_pgrb2_f03
#       resources: !calc ( doc.resource_demo.run_nothing )
#       #Time: !timedelta +4:40:00

#     fax: !Family
#       jgfs_fax_f00: !Task
#         ecflow_def: |
#           edit FCSTHR '00'
#         <<: *exclusive_task_template
#         Trigger: !Depend ( up.up.prdgen.jgfs_pgrb2_f00 & up.up.prdgen.jgfs_pgrb2_anl )
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_fax_anl: !Task
#         ecflow_def: |
#           edit FCSTHR 'anl'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_anl
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_fax_wafs_f12: !Task
#         ecflow_def: |
#           edit FCSTHR '12'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f12
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_fax_wafs_f24: !Task
#         ecflow_def: |
#           edit FCSTHR '24'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f24
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_fax_wafs_f36: !Task
#         ecflow_def: |
#           edit FCSTHR '36'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f36
#         resources: !calc ( doc.resource_demo.run_nothing )
#     #endfamily fax

#     grib_wafs: !Family
#       jgfs_wafs_f00: !Task
#         ecflow_def: |
#           edit FCSTHR '00'
#         <<: *exclusive_task_template
#         Trigger: !Depend ( up.up.prdgen.jgfs_pgrb2_f00 & up.up.prdgen.jgfs_pgrb2_f120 & up.grib2_wafs.jgfs_wafs_grib2 )
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_wafs_f06: !Task
#         ecflow_def: |
#           edit FCSTHR '06'
#         <<: *exclusive_task_template
#         Trigger: !Depend ( up.up.prdgen.jgfs_pgrb2_f06 & jgfs_wafs_f00 )
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_wafs_f12: !Task
#         ecflow_def: |
#           edit FCSTHR '12'
#         <<: *exclusive_task_template
#         Trigger: !Depend ( up.up.prdgen.jgfs_pgrb2_f12 & jgfs_wafs_f06 )
#         resources: !calc ( doc.resource_demo.run_nothing )

#       # tasks every 6 hours till f120

#       jgfs_wafs_f120: !Task
#         ecflow_def: |
#           edit FCSTHR '120'
#         <<: *exclusive_task_template
#         Trigger: !Depend ( up.up.prdgen.jgfs_pgrb2_f120 & jgfs_wafs_f114 )
#         resources: !calc ( doc.resource_demo.run_nothing )
#     #endfamily grib_wafs

#     bufr_sounding: !Family
#       jgfs_postsnd: !Task
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.post.jgfs_post_manager.release_post00
#         resources: !calc ( doc.resource_demo.run_nothing )

#     bulletins: !Family
#       jgfs_fbwind: !Task
#         <<: *exclusive_task_template
#         Trigger: !Depend ( up.up.post.jgfs_post_f06 & up.up.post.jgfs_post_f12 & up.up.post.jgfs_post_f24 )
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_cyclone_tracker: !Task
#         <<: *exclusive_task_template
#         # Very long trigger up.up.post.jgfs_post_f00-f180 & up.up.prdgen.jgfs_pgrb2_f00-f180
#         Trigger: !Depend ( up.up.post.jgfs_post_f00 & up.up.post.jgfs_post_f06 & up.up.prdgen.jgfs_pgrb2_f00 & up.up.prdgen.jgfs_pgrb2_f06 )
#         resources: !calc ( doc.resource_demo.run_nothing )

#     grib2_wafs: !Family
#       jgfs_wafs_grib2: !Task
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f00
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_wafs_blending: !Task
#         <<: *exclusive_task_template
#         Trigger: !Depend jgfs_wafs_grib2
#         #Time: !timedelta +4:33:00
#         resources: !calc ( doc.resource_demo.run_nothing )

#     grib_awips: !Family
#       jgfs_awips_f00: !Task
#         ecflow_def: |
#           edit FCSTHR '00'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f00
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_awips_f06: !Task
#         ecflow_def: |
#           edit FCSTHR '06'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f06
#         resources: !calc ( doc.resource_demo.run_nothing )

#       # tasks every 6 hours till f240

#       jgfs_awips_f240: !Task
#         ecflow_def: |
#           edit FCSTHR '240'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f240
#         resources: !calc ( doc.resource_demo.run_nothing )

#     awips_1p0deg: !Family
#       ecflow_def: |
#         edit RES '1p0deg'
#         edit RESC '1P0DEG'
#         #edit ECF_FILES '/gpfs/hps3/emc/global/noscrub/emc.glopara/ecflow/fv3/scripts/gfs/post_processing/awips'
#         edit ECF_FILES '{doc.settings.ECF_HOME}/scripts'

#       jgfs_awips_f000: !Task
#         ecflow_def: |
#           edit FCSTHR '000'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f00
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_awips_f006: !Task
#         ecflow_def: |
#           edit FCSTHR '006'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f06
#         resources: !calc ( doc.resource_demo.run_nothing )

#       # tasks every 6 hours till f240

#       jgfs_awips_f240: !Task
#         ecflow_def: |
#           edit FCSTHR '240'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f240
#         resources: !calc ( doc.resource_demo.run_nothing )
#     #endfamily awips_1p0deg

#     awips_20km: !Family
#       ecflow_def: |
#         edit RES '20km'
#         edit RESC '20KM'
#         #edit ECF_FILES '/gpfs/hps3/emc/global/noscrub/emc.glopara/ecflow/fv3/scripts/gfs/post_processing/awips'
#         edit ECF_FILES '{doc.settings.ECF_HOME}/scripts'

#       jgfs_awips_f000: !Task
#         ecflow_def: |
#           edit FCSTHR '000'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f00
#         resources: !calc ( doc.resource_demo.run_nothing )

#       jgfs_awips_f003: !Task
#         ecflow_def: |
#           edit FCSTHR '003'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f03
#         resources: !calc ( doc.resource_demo.run_nothing )

#       # tasks every 3 hours till f240

#       jgfs_awips_f240: !Task
#         ecflow_def: |
#           edit FCSTHR '240'
#         <<: *exclusive_task_template
#         Trigger: !Depend up.up.prdgen.jgfs_pgrb2_f240
#         resources: !calc ( doc.resource_demo.run_nothing )
#     #endfamily awips_20km

    #endfamily post_processing

    post: !Family

      #This is a dummy task as a placeholder
      dummy: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.forecast
        resources: !calc ( doc.resource_demo.run_nothing )

#     jgfs_post_manager: !Task
#       <<: *exclusive_task_template
#       Trigger: !Depend ( up.jgfs_analysis & up.forecast )
#       release_postanl: !DataEvent {file="/dev/null"}
#       release_post00: !DataEvent {file="/dev/null"}
#       # events from release_post00  to release_post384
#       release_post384: !DataEvent {file="/dev/null"}
#       resources: !calc ( doc.resource_demo.run_nothing )

#     jgfs_post_anl: !Task
#       ecflow_def: |
#         edit FHR 'anl'
#         edit HR 'anl'
#       <<: *exclusive_task_template
#       Trigger: !Depend jgfs_post_manager.release_postanl
#       release_pgrb2_anl: !DataEvent {file="/dev/null"}
#       resources: !calc ( doc.resource_demo.run_nothing )

#     jgfs_post_f00: !Task
#       ecflow_def: |
#         edit FHR 'f00'
#         edit HR '00'
#       <<: *exclusive_task_template
#       Trigger: !Depend jgfs_post_manager.release_post00
#       resources: !calc ( doc.resource_demo.run_nothing )

#     jgfs_post_f01: !Task
#       ecflow_def: |
#         edit FHR 'f01'
#         edit HR '01'
#       <<: *exclusive_task_template
#       Trigger: !Depend jgfs_post_manager.release_post01
#       resources: !calc ( doc.resource_demo.run_nothing )

#       # tasks from jgfs_post_f00 to jgfs_post_f384

#     jgfs_post_f384: !Task
#       ecflow_def: |
#         edit FHR 'f384'
#         edit HR '384'
#       <<: *exclusive_task_template
#       Trigger: !Depend jgfs_post_manager.release_post384
#       resources: !calc ( doc.resource_demo.run_nothing )

#     jgfs_post_f01: !Task
#       ecflow_def: |
#         edit FHR 'f01'
#         edit HR '01'
#       <<: *exclusive_task_template
#       Trigger: !Depend jgfs_post_manager.release_post01
#       resources: !calc ( doc.resource_demo.run_nothing )

#     jgfs_pgrb2_spec_post: !Task
#       <<: *exclusive_task_template
#       # Very long trigger jgfs_post_f336-f384 every 12h
#       Trigger: !Depend ( jgfs_post_f336 & jgfs_post_f384 )
#       resources: !calc ( doc.resource_demo.run_nothing )
    #endfamily post

    prdgen: !Family
      #This is a dummy task as a placeholder
      dummy: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.post
        resources: !calc ( doc.resource_demo.run_nothing )

      jgfs_pgrb2_manager: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.post
        release_pgrb2_00: !DataEvent {file="/dev/null"}
        # events from release_pgrb2_00 to release_pgrb2_240 every 3hrs
        # and then to release_pgrb2_384 every 12 hrs
        # And Note event number start from 2 instead of 1
        release_post384: !DataEvent {file="/dev/null"}
        resources: !calc ( doc.resource_demo.run_nothing )

      #Need to add other tasks in this prdgen family

    #endfamily prdgen

    gempak: !Family
      jgfs_gempak_upapgif: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.dump.jgfs_dump
        resources: !calc ( doc.resource_demo.run_nothing )

      jgfs_gempak_ncdc: !Task
        <<: *exclusive_task_template
        Trigger: !Depend jgfs_gempak.is_running()
        resources: !calc ( doc.resource_demo.run_nothing )

      jgfs_gempak: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.jgfs_analysis
        resources: !calc ( doc.resource_demo.run_nothing )

      jgfs_gempak_meta: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.jgfs_analysis
        resources: !calc ( doc.resource_demo.run_nothing )

#     jgfs_pgrb2_spec_gempak: !Task
#       <<: *exclusive_task_template
#       Trigger: !Depend up.post.jgfs_pgrb2_spec_post
#       resources: !calc ( doc.resource_demo.run_nothing )
    #endfamily gempak

  #endfamily gfs

  gdas: !Family
    ecflow_def: |
      edit ECF_JOB_CMD 'lsub %ECF_JOB% %ECF_JOBOUT% %MACHINE%'
      edit ECF_FILES '{doc.settings.ECF_HOME}/scripts'
      edit PROJ '%PROJENVIR%'

    jgdas_verfrad: !Task
      <<: *exclusive_task_template
      Trigger: !Depend enkf
      resources: !calc ( doc.resource_demo.run_nothing )

    jgdas_vminmon: !Task
      <<: *exclusive_task_template
      Trigger: !Depend analysis.jgdas_analysis_high
      resources: !calc ( doc.resource_demo.run_nothing )

    dump: !Family
      jgdas_ics: !Task
        <<: *exclusive_task_template
        release_gdas00_ics: !DataEvent {file="/dev/null"}
        resources: !calc ( doc.resource_demo.run_nothing )

      #jgdas_dump_post: !Task
      #  Trigger: !Depend jgdas_dump
      #  release_sfcprep: !DataEvent {file="/dev/null"}
      #  release_gdas00_dump_alert: !DataEvent {file="/dev/null"}
      #  ecf_file: *ecf_file_template
      #  resources: !calc ( doc.resource_demo.run_nothing )
      #  accounting: *exclusive_accounting
      #  J_JOB: nothing
 
      jgdas_tropcy_qc_reloc: !Task
        <<: *exclusive_task_template
        Trigger: !Depend jgdas_dump
        #Time: !timedelta +5:50:00
        resources: !calc ( doc.resource_demo.run_nothing )

      #Replaced by emc version of dump job 
      #This dump job should be using NCO version when delivery to NCO
      jgdas_dump: !Task
        <<: *exclusive_task_template
        release_sfcprep: !DataEvent {file="/dev/null"}
        #Time: !timedelta +6:20:00
        resources: !calc ( doc.resource_demo.run_nothing )

    prep: !Family
      jgdas_emcsfc_sfc_prep: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.dump.jgdas_dump.release_sfcprep
        resources: !calc ( doc.resource_demo.run_nothing )

      jgdas_prep: !Task
        #Trigger: !Depend (up.dump.jgdas_dump & up.dump.jgdas_tropcy_qc_reloc & up.gdas.post.at('-6:00:00') )
        <<: *exclusive_task_template
        Trigger: !Depend ( up.dump.jgdas_dump & up.dump.jgdas_tropcy_qc_reloc )
        resources: !calc ( doc.resource_demo.run_prep )

      jgdas_prep_post: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.analysis.jgdas_analysis_high
        resources: !calc ( doc.resource_demo.run_nothing )

    analysis: !Family
      jgdas_analysis_high: !Task
        <<: *exclusive_task_template
        #Trigger: !Depend ( up.prep.jgdas_prep & up.prep.jgdas_emcsfc_sfc_prep & up.enkf.jgdas_enkf_post.at('-6:00:00') )
        Trigger: !Depend ( up.prep.jgdas_prep & up.prep.jgdas_emcsfc_sfc_prep )
        release_fcst: !DataEvent {file="/dev/null"}
        resources: !calc ( doc.resource_demo.run_anal )

    forecast: !Family
      #jgdas_forecast_high: !Task
      #  <<: *exclusive_task_template
      #  Trigger: !Depend ( up.jgdas_analysis.release_fcst & up.enkf.innovate )
      #  release_fcst: !DataEvent {file="/dev/null"}
      #  resources: !calc ( doc.resource_demo.run_gdasfcst )
      #  J_JOB: JGLOBAL_FORECAST

      jgdas_forecast: !Task
        <<: *exclusive_task_template
        Trigger: !Depend ( up.analysis.jgdas_analysis_high.release_fcst & up.enkf.innovate )
        release_fcst: !DataEvent {file="/dev/null"}
        resources: !calc ( doc.resource_demo.run_gdasfcst )
        J_JOB: JGLOBAL_FORECAST

    post_processing: !Family
      bulletins: !Family
        jgdas_mknavybulls: !Task
          <<: *exclusive_task_template
          #Trigger: !Depend ( up.up.dump.jgdas_dump_post )
          Trigger: !Depend ( up.up.dump.jgdas_dump )
          resources: !calc ( doc.resource_demo.run_nothing )

    gempak: !Family
      jgdas_gempak: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.forecast.jgdas_forecast
        resources: !calc ( doc.resource_demo.run_nothing )

      jgdas_gempak_meta: !Task
        <<: *exclusive_task_template
        Trigger: !Depend jgdas_gempak
        resources: !calc ( doc.resource_demo.run_nothing )

      jgdas_gempak_ncdc: !Task
        <<: *exclusive_task_template
        Trigger: !Depend jgdas_gempak
        resources: !calc ( doc.resource_demo.run_nothing )
    #endfamily gempak

    post: !Family
      #jgdas_post_high: !Task
      #  <<: *exclusive_task_template
      #  Trigger: !Depend up.forecast.jgdas_forecast_high
      #  resources: !calc ( doc.resource_demo.run_gdaspost )
      #  J_JOB: post
      #jgdas_post_hrly_high: !Task
      #  <<: *exclusive_task_template
      #  Trigger: !Depend up.forecast.jgdas_forecast_high
      #  resources: !calc ( doc.resource_demo.run_gdaspost )
      #  J_JOB: post
      jgdas_post: !Task
        <<: *exclusive_task_template
        Trigger: !Depend up.forecast.jgdas_forecast
        resources: !calc ( doc.resource_demo.run_gdaspost )
        J_JOB: post
    #endfamily post

    enkf: !Family
      jgdas_enkf_select_obs: !Task
        <<: *exclusive_task_template
        Trigger: !Depend  ( up.prep.jgdas_prep & jgdas_enkf_post.at('-6:00:00') )
        resources: !calc ( doc.resource_demo.run_eobs )

      innovate: !TaskArray
        Trigger: !Depend jgdas_enkf_select_obs
        Dimensions:
          groupid: !calc tools.seq(1,doc.settings.ENKF_INNOVATE_GROUPS,1)
        jgdas_enkf_innovate_obs_grp: !TaskElement
          <<: *exclusive_task_template
          Foreach: [ group ]
          Name: !expand "jgdas_enkf_innovate_obs_grp{idx.groupid}"
          resources: !calc ( doc.resource_demo.run_eomg )
          J_JOB: jgdas_innovate

      jgdas_enkf_update: !Task
        <<: *exclusive_task_template
        ecflow_def: |
          edit ECF_PASS 'FREE'
        Trigger: !Depend innovate
        resources: !calc ( doc.resource_demo.run_eupd )

      jgdas_enkf_inflate_recenter: !Task
        <<: *exclusive_task_template
        Trigger: !Depend ( jgdas_enkf_update & up.analysis.jgdas_analysis_high )
        resources: !calc ( doc.resource_demo.run_ecen )

      forecast: !TaskArray
        Trigger: !Depend up.enkf.jgdas_enkf_inflate_recenter
        Dimensions:
          groupid: !calc tools.seq(1,doc.settings.ENKF_FORECAST_GROUPS,1)
        jgdas_enkf_fcst_grp: !TaskElement
          <<: *exclusive_task_template
          Foreach: [ group ]
          Name: !expand "jgdas_enkf_fcst_grp{idx.groupid}"
          resources: !calc ( doc.resource_demo.run_efcs )
          J_JOB: JGLOBAL_FORECAST
          
      jgdas_enkf_post: !Task
        <<: *exclusive_task_template
        Trigger: !Depend forecast
        resources: !calc ( doc.resource_demo.run_epos )

    #endfamily enkf

  #endfamily gdas

  cycle_end: !Task
   ecflow_def: !expand |
     edit ECF_JOB_CMD '%ECF_JOB% 1> %ECF_JOBOUT% 2>&1'
     edit ECF_PASS 'FREE'
   <<: *exclusive_task_template
   #time 23:00
   #Time: !timedelta +23:00:00
   resources: !calc ( doc.resource_demo.run_nothing )

  #hpss archive tasks are run in the hpss_archive suite 
  #archive: !Family
  #  gdasarch: !Task
  #    <<: *shared_task_template
  #    Trigger: !Depend up.gdas.jgdas_verfrad
  #    resources: !calc ( doc.resource_demo.run_arch )
  #    J_JOB: gdasarch

  #  gfsarch: !Task
  #    <<: *shared_task_template
  #    Trigger: !Depend up.gfs.jgfs_vrfy
  #    resources: !calc ( doc.resource_demo.run_arch )
  #    J_JOB: gfsarch

  #  earc: !TaskArray
  #    Trigger: !Depend up.gdas.enkf.jgdas_enkf_post
  #    Dimensions:
  #      groupid: !calc tools.seq(1,doc.settings.ENKF_ARCHIVE_GROUPS,1)
  #    grp: !TaskElement
  #      <<: *shared_task_template
  #      Foreach: [ group ]
  #      Name: !expand "grp{idx.groupid}"
  #      resources: !calc ( doc.resource_demo.run_arch )
  #      J_JOB: earc

  final: !Task
    <<: *shared_task_template
    resources: !calc ( doc.resource_demo.run_nothing )


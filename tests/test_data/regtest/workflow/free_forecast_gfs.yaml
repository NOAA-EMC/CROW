suite: !Cycle
  <<: *suite_defaults

  ics: !Family
    Disable: !calc >-
      doc.settings.get("IC_CDUMP","") and not doc.settings.chgres_and_convert_ics
    model: 'gfs' # useless but required
    jgfs_emc_getics: !Task
      <<: *service_task_template
      Disable: !calc doc.settings.get("IC_CDUMP","") 
      resources: !calc partition.resources.run_getic
      J_JOB: rocoto/getic.sh
      ecf_module_commands: "# getics.sh will load modules instead"
      model: gfs

    jgfs_emc_fv3ic: !Task
      <<: *exclusive_task_template
      Disable: !calc not doc.settings.chgres_and_convert_ics
      Trigger: !Depend jgfs_emc_getics
      resources: !calc partition.resources.run_fv3ic
      J_JOB: rocoto/fv3ic.sh
      ecf_module_commands: "# fv3ic.sh will load modules instead"
      model: gfs

  gfs: !Family
    Trigger: !Depend ics
    model: 'gfs'

    forecast: !Family
      jgfs_forecast_high: !Task
        <<: *exclusive_task_template
        resources: !calc partition.resources.run_gfsfcst
        J_JOB: JGLOBAL_FORECAST

    post: !TaskArray
      model: !calc up.model
      Dimensions:
        fhr: !calc doc.gfs_output_settings.gfs_forecast_hours
      jgfs_post_manager_el: !TaskElement
        <<: *exclusive_task_template
        model: !calc up.model
        Disable: !calc metasched.type == 'rocoto'
        Trigger: !Depend up.forecast.is_running()
        Complete: !Depend up.forecast
        Foreach: [ ]
        ecflow_command: *post_manager_job_contents
        J_JOB: post_manager
        Name: jgfs_post_manager
        resources: !calc partition.resources.run_gfs_post_manager
        release_postanl: !DataEvent
          file: !expand >-
            {metasched.varref("COM")}/gfs.{metasched.datestring("%Y%m%d/%H/")}gfs.t{metasched.datestring("%H")}z.logf000.nemsio
        release_post_fhr: !DataEventElement
          Name: !expand "release_post{dimval.fhr:02d}"
          Foreach: [ fhr ]
          file: !expand >-
            {metasched.varref("COM")}/gfs.{metasched.datestring("%Y%m%d/%H/")}gfs.t{metasched.datestring("%H")}z.logf{dimval.fhr:03d}.nemsio
        # NOTE: the above files must match post_manager.yaml

      jgfs_post_anl: !Task
        <<: *exclusive_task_template
        model: !calc up.model
        FHRGRP: '000'
        FHRLST: anl
        more_vars: [ FHRGRP, FHRLST, FHR, HR ]
        FHR: !expand 'anl'
        HR: !expand 'anl'
        Trigger: !Depend jgfs_post_manager.release_postanl | up.forecast
        release_pgrb2_anl: !DataEvent {file="/dev/null"}
        resources: !calc partition.resources.run_gfspost
        J_JOB: JGLOBAL_NCEPPOST
        ecflow_command: !expand |
          export post_times=anl FHRLST={FHRLST} FHRGRP={FHRGRP}
          $HOMEgfs/jobs/{J_JOB}
        rocoto_command: !expand >-
          {rocoto_load_modules} ;
          /usr/bin/env post_times=anl &HOMEgfs;/jobs/{J_JOB}
        more_vars: [ FHRGRP, FHRLST ]

      jgfs_post_fhr_el: !TaskElement
        <<: *exclusive_task_template
        Foreach: [ fhr  ]
        resources: !calc partition.resources.run_gfspost
        Name: !expand jgfs_post_f{dimval.fhr:02d}
        FHRGRP: !expand "{dimidx.fhr+1:03d}"
        FHRLST: !expand "f{dimval.fhr:03d}"
        FHR: !expand 'f{dimval.fhr:02d}'
        HR: !expand '{dimval.fhr:02d}'
        more_vars: [ FHRGRP, FHRLST, FHR, HR ]
        J_JOB: JGLOBAL_NCEPPOST
        Trigger: !Depend jgfs_post_manager.depend("release_post{F:02d}",F=[dimval.fhr]) | up.forecast
        ecflow_command: !expand |
          export post_times={dimval.fhr:03d} FHRLST={FHRLST} FHRGRP={FHRGRP}
          $HOMEgfs/jobs/{J_JOB}
        rocoto_command: !expand >-
          {rocoto_load_modules} ;
          /usr/bin/env post_times={dimval.fhr:03d} &HOMEgfs;/jobs/{J_JOB}
    #endfamily post

    jgfs_emc_vrfy: !Task
      <<: *exclusive_task_template
      Trigger: !Depend post
      resources: !calc partition.resources.run_gfsvrfy
      J_JOB: rocoto/vrfy.sh
      ecf_module_commands: "# vrfy.sh will load modules instead"
      
  #endfamily gfs

  archive: !Family
    ecflow_def:
      edit ECF_TRIES '3'

    jgfs_archive: !Task
      <<: *service_task_template
      Disable: !calc doc.settings.gfs_cyc == 0
      Trigger: !Depend up.gfs.jgfs_emc_vrfy
      resources: !calc partition.resources.run_arch
      Disable: !calc not doc.archiving.archive_to_hpss
      J_JOB: rocoto/arch.sh
      ecf_module_commands: "# arch.sh will load modules instead"
      model: gfs
      ecflow_def:
        time +00:10

  final: !Task
    <<: *service_task_template
    Disable: !calc not metasched.type=="rocoto"
    resources: !calc partition.resources.run_nothing
    rocoto_command: /bin/true
    model: gfs # useless but required


# This file is used to generate config.prep, which controls
# observation pre-processing.  The output of this is sent into the GFS
# or GDAS analysis.  The observation processing system is not part of
# this public release, so this file is ignored.

config_prep:
  filename: config.prep
  content: !expand |
    #!/bin/ksh -x
    
    # This file is automatically generated from the YAML-based system
    # in ecf/ecfutils/.  Any changes will be overwritten if
    # setup_case.sh is rerun.
    
    ########## config.prep ##########
    # Prep step specific
    
    echo "BEGIN: config.prep"
    
    # Get task specific resources
    . $EXPDIR/config.resources prep

    # Source machine runtime environment
    . $BASE_ENV/{doc.platform.name}.env prep
    status=$?
    [[ $status -ne 0 ]] && exit $status
    
    export DO_MAKEPREPBUFR="{tools.YES_NO(doc.data_assimilation.DO_MAKEPREPBUFR)}"   # if NO, will copy prepbufr from globaldump
    
    # Relocation and syndata QC
    export PROCESS_TROPCY="{tools.YES_NO(doc.data_assimilation.PROCESS_TROPCY)}"
    [[ $RUN_ENVIR == "nco" && $envir == "prod" ]] && export PROCESS_TROPCY="YES"
    export DO_RELOCATE="{tools.YES_NO(doc.data_assimilation.DO_RELOCATE)}"
    export TROPCYQCRELOSH="$HOMEgfs/scripts/extropcy_qc_reloc.sh.ecf"
    export SENDCOM="YES"
    
    export HOMERELO=$HOMEgfs
    export EXECRELO=${{HOMERELO}}/exec
    export FIXRELO=${{HOMERELO}}/fix/fix_am
    export USHRELO=${{HOMERELO}}/ush
    
    export cycle="t\"$cyc\"z"
    export OPREFIX="{doc.data_assimilation.OPREFIX}"
    export COMOUT="$ROTDIR/$CDUMP.$PDY/$cyc"
    [[ ! -d $COMOUT ]] && mkdir -p $COMOUT

    export COMIN_OBS={doc.data_assimilation.COMIN_OBS}
    export COMSP=$COMIN_OBS/$OPREFIX

    ###############################################################
    # If ROTDIR_DUMP=YES, copy dump files to rotdir
    if [ $ROTDIR_DUMP = "YES" ]; then
       $HOMEgfs/ush/getdump.sh $CDATE $CDUMP {doc.data_assimilation.COM_OBS}/$CDATE/$CDUMP$DUMP_SUFFIX $COMOUT
       status=$?
       [[ $status -ne 0 ]] && exit $status

       # Ensure previous cycle gdas dumps are available (used by cycle & downstream)
       GDATE=$($NDATE -$assim_freq $CDATE)
       gPDY=$(echo $GDATE | cut -c1-8)
       gcyc=$(echo $GDATE | cut -c9-10)
       GDUMP=gdas
       gCOMOUT="$ROTDIR/$GDUMP.$gPDY/$gcyc"
       if [ ! -s $gCOMOUT/$GDUMP.t\$gcyc\z.updated.status.tm00.bufr_d ]; then
          $HOMEgfs/ush/getdump.sh $GDATE $GDUMP {doc.data_assimilation.COM_OBS}/$GDATE/$GDUMP$DUMP_SUFFIX $gCOMOUT
          status=$?
          [[ $status -ne 0 ]] && exit $status
       fi
    fi

    ###############################################################
    # For running real-time parallels on WCOSS_C, execute tropcy_qc and
    # copy files from operational syndata directory to a local directory.
    # Otherwise, copy existing tcvital data from globaldump.

    if [ $PROCESS_TROPCY = "YES" ]; then

        export ARCHSYNDNCO=$COMROOTp1/arch/prod/syndat
        if [ $RUN_ENVIR != "nco" ]; then
            export ARCHSYND=$ROTDIR/syndat
            if [ ! -d $ARCHSYND ]; then mkdir -p $ARCHSYND; fi
            if [ ! -s $ARCHSYND/syndat_akavit ]; then
                for file in syndat_akavit syndat_dateck syndat_stmcat.scr syndat_stmcat syndat_sthisto syndat_sthista ; do
                    cp $ARCHSYNDNCO/$file $ARCHSYND/.
                done
            fi
        fi

        [[ $ROTDIR_DUMP = "YES" ]] && rm $COMOUT/{doc.data_assimilation.OPREFIX}syndata.tcvitals.tm00

        $HOMEgfs/jobs/JGLOBAL_TROPCY_QC_RELOC
        status=$?
        [[ $status -ne 0 ]] && exit $status

    else
       [[ $ROTDIR_DUMP = "NO" ]] && cp $COMIN_OBS/{doc.data_assimilation.OPREFIX}syndata.tcvitals.tm00 $COMOUT/
    fi

    ###############################################################
    # Generate prepbufr files from dumps or copy from OPS
    if [ $DO_MAKEPREPBUFR = "YES" ]; then
        if [ $ROTDIR_DUMP = "YES" ]; then
           rm $COMOUT/{doc.data_assimilation.OPREFIX}prepbufr
           rm $COMOUT/{doc.data_assimilation.OPREFIX}prepbufr.acft_profiles
           rm $COMOUT/{doc.data_assimilation.OPREFIX}nsstbufr
        fi
        export job="j\"$CDUMP\"_prep_\"$cyc
        export DATAROOT="$RUNDIR/$CDATE/$CDUMP/prepbufr"
        export COMIN="$ROTDIR/$CDUMP.$PDY/$cyc"
        export COMINgdas="$ROTDIR/gdas.$PDY/$cyc"
        export COMINgfs="$ROTDIR/gfs.$PDY/$cyc"

        $HOMEobsproc_network/jobs/JGLOBAL_PREP
        status=$?
        [[ $status -ne 0 ]] && exit $status

    else
        if [ $ROTDIR_DUMP = "NO" ]; then
           $NCP $COMIN_OBS/{doc.data_assimilation.OPREFIX}prepbufr               $COMOUT/{doc.data_assimilation.OPREFIX}prepbufr
           $NCP $COMIN_OBS/{doc.data_assimilation.OPREFIX}prepbufr.acft_profiles $COMOUT/{doc.data_assimilation.OPREFIX}prepbufr.acft_profiles
           [[ $DONST = "YES" ]] && $NCP $COMIN_OBS/{doc.data_assimilation.OPREFIX}nsstbufr $COMOUT/{doc.data_assimilation.OPREFIX}nsstbufr
        fi
    fi

    echo "END: config.prep"
    
